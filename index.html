
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTR Analytics Suite</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- MODERN THEME VARIABLES --- */
            --font-main: 'Plus Jakarta Sans', sans-serif;

            /* Light Mode */
            --bg-body: #f1f5f9;       
            --bg-sidebar: #ffffff;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.8);
            
            --text-main: #1e293b;     
            --text-muted: #64748b;    
            
            --border-color: #e2e8f0;  
            --shadow-card: 0 4px 20px -2px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            
            /* Accents */
            --accent-teal: #14b8a6;      --accent-teal-soft: #ccfbf1; 
            --accent-blue: #3b82f6;      --accent-blue-soft: #dbeafe; 
            --accent-red: #f43f5e;       --accent-red-soft: #ffe4e6;  
            --accent-green: #10b981;     --accent-green-soft: #d1fae5;
            --accent-amber: #f59e0b;     --accent-amber-soft: #fef3c7;
            --accent-purple: #8b5cf6;    --accent-purple-soft:#ede9fe;
            --accent-slate: #64748b;     --accent-slate-soft: #f1f5f9;
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-body: #0f172a;       
            --bg-sidebar: #1e293b;    
            --bg-card: #1e293b;
            --bg-glass: rgba(30, 41, 59, 0.85);

            --text-main: #f8fafc;     
            --text-muted: #94a3b8;    
            
            --border-color: #334155;  
            --shadow-card: 0 4px 20px -2px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 10px 30px -5px rgba(0, 0, 0, 0.5);

            --accent-teal-soft: rgba(20, 184, 166, 0.15);
            --accent-blue-soft: rgba(59, 130, 246, 0.15);
            --accent-red-soft: rgba(244, 63, 94, 0.15);
            --accent-green-soft: rgba(16, 185, 129, 0.15);
            --accent-amber-soft: rgba(245, 158, 11, 0.15);
            --accent-purple-soft: rgba(139, 92, 246, 0.15);
            --accent-slate-soft: rgba(148, 163, 184, 0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); }
        *::-webkit-scrollbar { width: 6px; height: 6px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        
        body { 
            display: flex; background-color: var(--bg-body); height: 100dvh; overflow: hidden; 
            font-size: 14px; color: var(--text-main); 
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Print Mode */
        body.print-mode { background: white !important; height: auto !important; overflow: visible !important; }
        body.print-mode .sidebar, body.print-mode .top-bar, body.print-mode .tl-controls { display: none !important; }
        body.print-mode .main { width: 1200px !important; margin: 0 auto; overflow: visible; height: auto; }
        body.print-mode .dashboard-grid { display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 15px !important; }
        body.print-mode .d-card, body.print-mode .kpi-card { background: white !important; border: 1px solid #ccc !important; box-shadow: none !important; }

        /* UI Elements */
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 90; opacity: 0; transition: opacity 0.3s; }
        .sidebar-overlay.active { display: block; opacity: 1; }

        .sidebar { 
            width: 280px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            flex-shrink: 0; z-index: 100; height: 100dvh; 
        }
        .sidebar.desktop-closed { width: 0; overflow: hidden; border: none; }
        
        .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 24px 20px; margin-bottom: 10px; flex-shrink: 0; }
        .sidebar-logo { max-height: 40px; max-width: 180px; object-fit: contain; }
        .sidebar-close-btn { background: transparent; border: none; color: var(--text-muted); width: 32px; height: 32px; cursor: pointer; border-radius: 50%; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .sidebar-close-btn:hover { background: var(--bg-body); color: var(--text-main); }

        .nav-section { padding: 0 20px; flex-shrink: 0; }
        .nav-label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin: 20px 0 10px 0px; text-transform: uppercase; letter-spacing: 0.05em; }
        
        .nav-item { 
            padding: 12px 16px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; 
            display: flex; align-items: center; gap: 14px; 
            color: var(--text-muted); font-weight: 500; font-size: 0.95rem; transition: all 0.2s ease; 
        }
        .nav-item:hover { background: var(--bg-body); color: var(--text-main); }
        .nav-item.active { background: var(--accent-teal); color: white; box-shadow: 0 4px 15px -3px rgba(20, 184, 166, 0.4); }
        .nav-item i { width: 20px; text-align: center; }

        .sidebar-content { padding: 0 20px 20px 20px; overflow-y: auto; flex-grow: 1; }
        .sidebar-footer { margin-top: auto; padding: 20px; border-top: 1px solid var(--border-color); flex-shrink: 0; background-color: var(--bg-sidebar); }
        
        .side-btn { width: 100%; padding: 12px; border-radius: 12px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; transition: 0.2s; font-size: 0.9rem; }
        .btn-upload-side { background: var(--text-main); color: var(--bg-card); }
        .btn-upload-side:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-reset-side { background: var(--accent-red-soft); color: var(--accent-red); }
        .btn-reset-side:hover { background: var(--accent-red); color: white; }
        
        .footer-credits { text-align: center; color: var(--text-muted); font-size: 0.7rem; margin-top: 15px; opacity: 0.7; }
        .dev-name { color: var(--accent-teal); font-weight: 700; }

        .filter-card { background: var(--bg-body); border-radius: 12px; padding: 10px 12px; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s; border: 1px solid transparent; }
        .filter-card:hover { transform: translateX(4px); background: var(--border-color); }
        .filter-card.active { background: white; border-color: var(--accent-teal); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        body.dark-mode .filter-card.active { background: var(--bg-body); border-color: var(--accent-teal); }
        
        .icon-box { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; margin-right: 12px; flex-shrink: 0; background: white; color: var(--text-muted); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        body.dark-mode .icon-box { background: rgba(255,255,255,0.05); }
        
        .unit-card.active .icon-box { background: var(--accent-blue); color: white; }
        .zone-card.active .icon-box { background: var(--accent-teal); color: white; }
        
        .card-name { font-weight: 600; font-size: 0.9rem; display: block; color: var(--text-main); }
        .card-count { font-size: 0.75rem; color: var(--text-muted); }

        .main { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; position: relative; width: 100%; }
        
        .top-bar { 
            background: var(--bg-glass); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 16px 30px; display: flex; align-items: center; justify-content: space-between; 
            position: sticky; top: 0; z-index: 40; flex-shrink: 0; border-bottom: 1px solid var(--border-color);
        }
        
        .page-header-title { font-size: 1.25rem; font-weight: 800; color: var(--text-main); margin-right: 20px; letter-spacing: -0.02em; }
        .top-icon-btn { background:transparent; border:none; cursor:pointer; font-size:1.1rem; color: var(--text-muted); margin-left:12px; padding: 8px; border-radius: 8px; transition: 0.2s; }
        .top-icon-btn:hover { background: var(--bg-body); color: var(--accent-teal); }
        
        .last-update { background: var(--bg-body); color: var(--text-main); padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-right: 10px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 8px; }
        .last-update i { color: var(--accent-teal); }
        
        .filters-active { display: flex; gap: 8px; margin-left: 15px; overflow-x: auto; padding-bottom: 2px; }
        .filter-tag { background: var(--text-main); color: var(--bg-body); padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; gap: 8px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .top-stats-container { display: flex; gap: 20px; padding: 30px 30px 10px 30px; flex-wrap: wrap; }
        .kpi-row { flex-grow: 1; display: flex; gap: 20px; flex-wrap: wrap; }
        
        .kpi-card { 
            flex: 1 1 180px; background: var(--bg-card); border-radius: 16px; padding: 20px; 
            box-shadow: var(--shadow-card); cursor: pointer; transition: all 0.3s;
            position: relative; overflow: hidden; border: 1px solid transparent;
        }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }
        .kpi-card.active { border-color: currentColor; background: var(--bg-card); }
        .kpi-card.active::after { content:''; position: absolute; inset: 0; background: currentColor; opacity: 0.05; pointer-events: none; }

        .k-gen { color: var(--text-muted); } .k-gen.active { color: var(--text-main); }
        .k-comp { color: var(--accent-green); }
        .k-open { color: var(--accent-amber); }
        .k-pend { color: var(--accent-red); }
        .k-plan { color: var(--accent-blue); }

        /* KPI Icons */
        .kpi-icon-bg { 
            position: absolute; right: 20px; top: 20px; 
            width: 45px; height: 45px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem;
        }
        .k-gen .kpi-icon-bg { background: var(--bg-body); color: var(--text-muted); }
        .k-comp .kpi-icon-bg { background: var(--accent-green-soft); color: var(--accent-green); }
        .k-open .kpi-icon-bg { background: var(--accent-amber-soft); color: var(--accent-amber); }
        .k-pend .kpi-icon-bg { background: var(--accent-red-soft); color: var(--accent-red); }
        .k-plan .kpi-icon-bg { background: var(--accent-blue-soft); color: var(--accent-blue); }

        .kpi-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8; margin-bottom: 8px; }
        .kpi-num { font-size: 2rem; font-weight: 800; line-height: 1; letter-spacing: -0.03em; }
        
        .issuer-card { flex: 0 0 220px; background: var(--bg-card); border-radius: 16px; padding: 15px 20px; box-shadow: var(--shadow-card); display: flex; flex-direction: column; justify-content: center; }
        .issuer-header { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; letter-spacing: 0.1em; border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
        .issuer-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .issuer-val { font-weight: 700; color: var(--text-main); }

        .chart-split-wrapper { display: flex; align-items: center; height: 100%; padding: 0 10px; gap: 20px; }
        .chart-split-left { position: relative; width: 45%; height: 180px; display: flex; justify-content: center; align-items: center; }
        .chart-split-right { width: 55%; display: flex; flex-direction: column; gap: 10px; justify-content: center; }
        
        .legend-item { 
            background: var(--bg-body); border-radius: 12px; padding: 10px 14px; 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; transition: all 0.2s; border: 1px solid transparent; 
        }
        .legend-item:hover { transform: scale(1.02); }
        .legend-item.active-filter { border-color: var(--text-main); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .legend-head { font-size: 0.8rem; font-weight: 700; color: var(--text-main); }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .legend-val { font-size: 1.1rem; font-weight: 800; color: var(--text-main); }

        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; padding: 20px 30px 50px 30px; }
        .d-card { background: var(--bg-card); border-radius: 20px; padding: 20px; box-shadow: var(--shadow-card); display: flex; flex-direction: column; min-width: 0; width: 100%; height: 100%; transition: transform 0.3s; }
        .d-card:hover { box-shadow: var(--shadow-hover); }

        .card-head { font-size: 1rem; font-weight: 700; color: var(--text-main); margin-bottom: 20px; display:flex; justify-content:space-between; align-items: center; letter-spacing: -0.01em; }
        .card-head small { font-weight: 400; color: var(--text-muted); font-size: 0.75rem; }

        .chart-box { position: relative; width: 100%; flex-grow: 1; min-height: 0; } 
        canvas { width: 100% !important; height: 100% !important; }
        .cb-standard { height: 260px; } .cb-tall { height: 460px; } 

        .a-dept { grid-column: span 2; } .a-cat { grid-column: span 1; } .a-equip { grid-column: span 1; } 
        .a-crit { grid-column: span 1; } .a-age { grid-column: span 1; } .a-act-taken { grid-column: span 1; } 
        .a-top-equip { grid-column: span 1; grid-row: span 2; } 
        .a-fault { grid-column: span 1; } .a-closed-under { grid-column: span 1; } .a-top-area { grid-column: span 1; }
        .a-trend { grid-column: span 2; } .a-saved { grid-column: span 2; } 
        .a-list { grid-column: span 4; height: 400px; overflow: hidden; } 

        .view-section { display: none; }
        .view-section.active-view { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- FIXED: Fault Grid & Badges --- */
        .fault-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; 
            height: 100%; /* Fill container */
            overflow-y: auto; padding-right: 5px; 
        }
        .fault-pill { 
            background: var(--bg-body); padding: 8px 12px; border-radius: 8px; 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 0.8rem; cursor: pointer; color: var(--text-main); 
            font-weight: 500; transition: 0.2s; border: 1px solid transparent; 
        }
        .fault-pill:hover, .fault-pill.active { background: var(--accent-teal-soft); color: var(--accent-teal); }
        
        /* Fixed Badge Contrast for Dark Mode */
        .fault-pill b { 
            background: rgba(0,0,0,0.08); 
            padding: 2px 7px; border-radius: 6px; 
            font-size: 0.75rem; color: var(--text-main); 
        }
        body.dark-mode .fault-pill b { 
            background: rgba(255,255,255,0.1); 
            color: #fff; 
        }

        .age-row { cursor: pointer; transition: 0.2s; color: var(--text-main); border-radius: 8px; } .age-row td { padding: 10px 8px; border-bottom: 1px solid var(--bg-body); }
        .age-row:hover { background: var(--bg-body); } .age-row.active { box-shadow: inset 4px 0 0 var(--accent-teal); background: var(--bg-body); font-weight: 700; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; } 
        th { text-align: left; padding: 12px; background: var(--bg-body); position: sticky; top: 0; z-index: 10; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid var(--border-color); } 
        td { padding: 12px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
        tr:last-child td { border-bottom: none; }

        .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; } 
        .dc-val { font-size: 2rem; font-weight: 800; color: var(--text-main); line-height: 1; letter-spacing: -0.02em; }

        /* --- FIXED: Timeline Alignment --- */
        .timeline-wrapper { padding: 20px 30px; }
        .tl-controls { display: flex; gap: 15px; margin-bottom: 30px; background: var(--bg-card); padding: 20px; border-radius: 16px; box-shadow: var(--shadow-card); }
        .tl-select { padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; flex-grow: 1; font-size: 0.95rem; background: var(--bg-body); color: var(--text-main); outline: none; }
        .timeline-container { position: relative; max-width: 900px; margin: 0 auto; }
        .timeline-container::after { content: ''; position: absolute; width: 2px; background-color: var(--border-color); top: 10px; bottom: 0; left: 29px; }
        .tl-item { padding: 0 0 30px 60px; position: relative; }
        .tl-dot { position: absolute; width: 16px; height: 16px; left: 22px; background-color: var(--bg-card); border: 4px solid var(--accent-teal); top: 5px; border-radius: 50%; z-index: 2; box-shadow: 0 0 0 4px var(--bg-body); }
        .tl-item.critical .tl-dot { border-color: var(--accent-red); }
        .tl-item.marginal .tl-dot { border-color: var(--accent-amber); }
        .tl-content { padding: 20px; background-color: var(--bg-card); border-radius: 16px; box-shadow: var(--shadow-card); border: 1px solid var(--border-color); }
        .tl-action-box { background: var(--accent-teal-soft); padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 3px solid var(--accent-teal); }
        
        .tl-date { 
            display: flex; 
            justify-content: space-between; /* Push items to edges */
            align-items: center; 
            width: 100%; 
            margin-bottom: 8px;
        }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: var(--bg-card); padding: 30px; border-radius: 20px; width: 450px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.3); color: var(--text-main); }
        
        @media (max-width: 1200px) {
            .dashboard-grid { grid-template-columns: 1fr 1fr; }
            .a-dept, .a-trend, .a-list, .a-saved { grid-column: span 2; }
            .a-top-equip { grid-row: auto; }
            .chart-split-wrapper { flex-direction: column; }
            .chart-split-left, .chart-split-right { width: 100%; }
        }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -280px; } .sidebar.mobile-active { left: 0; }
            .dashboard-grid { grid-template-columns: 1fr; padding: 15px; } 
            .a-dept, .a-cat, .a-act-taken, .a-equip, .a-crit, .a-age, .a-fault, .a-list, .a-top-equip, .a-top-area, .a-trend, .a-closed-under, .a-saved { grid-column: span 1; grid-row: auto; }
            .top-stats-container { padding: 15px; } .kpi-row { gap: 10px; } .kpi-card { flex: 1 1 100%; }
        }
    </style>
</head>
<body>

    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="settingsModal" class="modal">
        <div class="modal-box">
            <h3 style="margin-bottom:20px; font-weight:800;">⚙️ Zone Configuration</h3>
            <div id="mappingContainer"></div>
            <button class="btn-save side-btn btn-upload-side" onclick="saveMappings()">Save Configuration</button>
            <button class="side-btn" style="background:var(--bg-body); color:var(--text-muted);" onclick="closeSettings()">Cancel</button>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="https://lgyladuiyezqccyjxqgn.supabase.co/storage/v1/object/public/Image/cbmlogo.png" alt="CBM Logo" class="sidebar-logo">
            <button class="sidebar-close-btn" onclick="toggleSidebar()"><i class="fas fa-chevron-left"></i></button>
        </div>
        
        <div class="nav-section">
            <div class="nav-label">Analytics</div>
            <div class="nav-item active" id="nav-dash" onclick="switchView('dashboard')">
                <i class="fas fa-table-columns"></i> Dashboard
            </div>
            <div class="nav-item" id="nav-time" onclick="switchView('timeline')">
                <i class="fas fa-clock-rotate-left"></i> History Timeline
            </div>
        </div>

        <div class="sidebar-content">
            <div class="nav-label">Filters</div>
            <div id="unitListContainer" style="margin-bottom:20px;"></div>
            <div class="nav-label">Zones</div>
            <div id="zoneListContainer"></div>
        </div>

        <div class="sidebar-footer">
            <input type="file" id="csvInput" accept=".csv" style="display:none;" onchange="handleUpload(event)">
            <button class="side-btn btn-upload-side" onclick="document.getElementById('csvInput').click()">
                <i class="fas fa-cloud-arrow-up"></i> Upload CSV
            </button>
            <button class="side-btn btn-reset-side" onclick="clearData()">
                <i class="fas fa-trash"></i> Reset Data
            </button>
            <div class="footer-credits">
                MTR Analytics Suite v2.4<br>
                <div style="margin-top:5px;">Engineered by <span class="dev-name">Sourav Biswal</span></div>
            </div>
        </div>
    </div>

    <div class="main" id="mainContent">
        <div class="top-bar">
            <div class="top-left">
                <button class="toggle-btn top-icon-btn" onclick="toggleSidebar()" style="margin-left:0; margin-right:15px;"><i class="fas fa-bars"></i></button>
                <span id="pageTitle" class="page-header-title">Overview</span>
                <div class="filters-active" id="activeFilters"></div>
            </div>
            <div style="display:flex; align-items:center;">
                <div class="last-update" id="lastUpdateContainer" style="display:none;">
                    <i class="fas fa-calendar-check"></i> <span id="lastUpdateDate">--</span>
                </div>
                <button class="top-icon-btn" onclick="toggleTheme()" title="Toggle Theme"><i class="fas fa-moon"></i></button>
                <button class="top-icon-btn" onclick="exportPDF()" title="Export PDF"><i class="fas fa-file-pdf"></i></button>
                <button class="top-icon-btn" onclick="openSettings()"><i class="fas fa-gear"></i></button>
            </div>
        </div>

        <div class="top-stats-container">
            <div class="kpi-row">
                <div class="kpi-card k-gen active" id="card-Generated" onclick="setKPI('Generated')">
                    <div class="kpi-content"><div class="kpi-title">Total Reports</div><div class="kpi-num" id="k-gen">0</div></div>
                    <div class="kpi-icon-bg"><i class="fas fa-file-lines"></i></div>
                </div>
                <div class="kpi-card k-comp" id="card-Completed" onclick="setKPI('Completed')">
                    <div class="kpi-content"><div class="kpi-title">Completed</div><div class="kpi-num" id="k-comp">0</div></div>
                    <div class="kpi-icon-bg"><i class="fas fa-circle-check"></i></div>
                </div>
                <div class="kpi-card k-open" id="card-Open" onclick="setKPI('Open')">
                    <div class="kpi-content"><div class="kpi-title">Open Cases</div><div class="kpi-num" id="k-open">0</div></div>
                    <div class="kpi-icon-bg"><i class="fas fa-folder-open"></i></div>
                </div>
                <div class="kpi-card k-pend" id="card-Pending" onclick="setKPI('Pending')">
                    <div class="kpi-content"><div class="kpi-title">Action Pending</div><div class="kpi-num" id="k-pend">0</div></div>
                    <div class="kpi-icon-bg"><i class="fas fa-clock"></i></div>
                </div>
                <div class="kpi-card k-plan" id="card-Planned" onclick="setKPI('Planned')">
                    <div class="kpi-content"><div class="kpi-title">Action Planned</div><div class="kpi-num" id="k-plan">0</div></div>
                    <div class="kpi-icon-bg"><i class="fas fa-calendar-day"></i></div>
                </div>
            </div>
            <div class="issuer-card">
                <div class="issuer-header">Analysis Source</div>
                <div class="issuer-row">
                    <div class="issuer-label"><i class="fas fa-user-tie" style="color:var(--text-muted)"></i> Human</div>
                    <div class="issuer-val" id="valAnalyst">0</div>
                </div>
                <div class="issuer-row">
                    <div class="issuer-label"><i class="fas fa-microchip" style="color:var(--accent-teal)"></i> AI Model</div>
                    <div class="issuer-val" id="valAI">0</div>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="view-section active-view">
            <div class="dashboard-grid">
                
                <div class="d-card a-dept">
                    <div class="card-head">Department Analysis <small>Click bars to filter</small></div>
                    <div class="chart-box cb-tall"><canvas id="cDept"></canvas></div>
                </div>
                <div class="d-card a-cat">
                    <div class="card-head">Category Distribution</div>
                    <div class="chart-box cb-standard"><canvas id="cCat"></canvas></div>
                </div>
                <div class="d-card a-equip">
                    <div class="card-head">Equipment Type</div>
                    <div class="chart-box cb-standard"><canvas id="cEquip"></canvas></div>
                </div>

                <div class="d-card a-crit">
                    <div class="card-head" style="color:var(--accent-red)">Criticality Overview</div>
                    <div class="chart-split-wrapper">
                        <div class="chart-split-left">
                            <canvas id="cCrit"></canvas>
                            <div class="donut-center"><div class="dc-val" id="valTotalCrit">0</div></div>
                        </div>
                        <div class="chart-split-right" id="critLegendList"></div>
                    </div>
                </div>

                <div class="d-card a-age">
                    <div class="card-head">Aging Analysis</div>
                    <table id="tAge"></table>
                </div>
                <div class="d-card a-act-taken">
                    <div class="card-head">Action Taken</div>
                    <div class="chart-box cb-standard">
                        <canvas id="cDoughnut"></canvas>
                        <div class="donut-center" style="pointer-events:auto;"><div class="dc-val" id="valActTaken">0</div></div>
                    </div>
                </div>
                
                <div class="d-card a-top-equip">
                    <div class="card-head" style="color:var(--accent-red)">Top 10 Bad Actors</div>
                    <div class="chart-box cb-tall"><canvas id="cTopEquip"></canvas></div>
                </div>

                <div class="d-card a-fault">
                    <div class="card-head">Fault Distribution</div>
                    <div class="fault-grid" id="faultList"></div>
                </div>
                
                <div class="d-card a-closed-under">
                    <div class="card-head" style="color:var(--accent-green)">Diagnosis Accuracy</div>
                    <div class="chart-split-wrapper">
                        <div class="chart-split-left">
                            <canvas id="cClosedUnder"></canvas>
                            <div class="donut-center"><div class="dc-val" id="valClosedUnder" style="font-size: 1.5rem;">0</div></div>
                        </div>
                        <div class="chart-split-right" id="diagnosisLegendList"></div>
                    </div>
                </div>

                <div class="d-card a-top-area">
                    <div class="card-head" style="color:var(--accent-amber)">Top 5 Abnormal Areas</div>
                    <div class="chart-box cb-standard"><canvas id="cTopArea"></canvas></div>
                </div>

                <div class="d-card a-trend">
                    <div class="card-head">7-Day Trend Analysis</div>
                    <div class="chart-box cb-standard"><canvas id="cTrend"></canvas></div>
                </div>
                <div class="d-card a-saved">
                    <div class="card-head">
                        <span style="color:var(--accent-purple)">Downtime Saved</span>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <select id="optFY" style="padding:4px 8px; font-size:0.8rem; border:1px solid var(--border-color); border-radius:6px; background:var(--bg-body); color:var(--text-main);" onchange="renderSavedChart()">
                                </select>
                            <span id="valTotalSaved" style="font-weight:800; color:var(--accent-purple); font-size:1rem;">0h</span>
                        </div>
                    </div>
                    <div class="chart-box cb-standard"><canvas id="cSaved"></canvas></div>
                </div>

                <div class="d-card a-list">
                    <div class="card-head">Action Registry</div>
                    <div style="overflow-y:auto; height:100%;">
                        <table id="tList">
                            <thead><tr><th>Date</th><th>Plant</th><th>Equip</th><th>Action</th><th>Remarks</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-timeline" class="view-section">
            <div class="timeline-wrapper">
                <div class="tl-controls">
                    <select id="tl-plant" class="tl-select" onchange="filterTimelineEquipment()">
                        <option value="">Select Plant...</option>
                    </select>
                    <select id="tl-equip" class="tl-select" onchange="renderTimeline()">
                        <option value="">Select Equipment...</option>
                    </select>
                </div>
                <div id="timeline-container" class="timeline-container">
                    <div style="text-align:center; color:var(--text-muted); padding:30px;">
                        Select a Plant and Equipment above to visualize history.
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let rawData=[], filteredData=[], activeKPI='Generated', filters={}; 
        let manualZoneMap=JSON.parse(localStorage.getItem('mtr_manual_map'))||{};
        let currentView = 'dashboard';
        let savedChartInstance = null;
        
        Chart.register(ChartDataLabels);

        // Modernized Chart Defaults
        Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
        Chart.defaults.color = '#64748b';
        Chart.defaults.scale.grid.color = 'transparent'; // Remove Grid Lines
        
        const ICONS={'Bearing':'fa-circle-notch','Alignment':'fa-ruler-combined','Balancing':'fa-crosshairs','Lubrication':'fa-oil-can','Electrical':'fa-bolt','Gear':'fa-gears','Flow':'fa-wind','Structure':'fa-cubes'};
        const ZONES_DEFAULT=['IRON MAKING','STEEL MAKING','PROCESS PLANT','OTHER'];
        let charts={};

        window.addEventListener('load', () => {
            if(localStorage.getItem('mtr_theme') === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelector('.top-icon-btn[title="Toggle Theme"] i').className = 'fas fa-sun';
            }

            const savedData = localStorage.getItem('mtr_data');
            if(savedData) {
                try { rawData = JSON.parse(savedData); processData(); renderSidebar(); applyFilters(); initTimelineFilters(); } catch(e) { console.error(e); }
            } else {
                document.getElementById('zoneListContainer').innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.85rem;">Upload Data via Bottom Button</div>';
            }
        });

        function handleUpload(e){
            const file=e.target.files[0];
            if(!file)return;
            Papa.parse(file,{header:true,skipEmptyLines:true,complete:(res)=>{
                rawData=res.data;
                localStorage.setItem('mtr_data', JSON.stringify(rawData));
                checkAutoMap(); processData(); renderSidebar(); applyFilters(); initTimelineFilters();
            }});
        }

        function clearData() { localStorage.removeItem('mtr_data'); location.reload(); }

        function toggleSidebar(){ 
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth <= 768) {
                sb.classList.toggle('mobile-active');
                overlay.classList.toggle('active');
            } else {
                sb.classList.toggle('desktop-closed');
            }
        }

        function switchView(viewName) {
            currentView = viewName;
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.getElementById('view-' + viewName).classList.add('active-view');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(viewName === 'dashboard') document.getElementById('nav-dash').classList.add('active');
            if(viewName === 'timeline') document.getElementById('nav-time').classList.add('active');
            const titleMap = { 'dashboard': 'Overview', 'timeline': 'Equipment History' };
            document.getElementById('pageTitle').innerText = titleMap[viewName];
            if (window.innerWidth <= 768) toggleSidebar();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('mtr_theme', isDark ? 'dark' : 'light');
            document.querySelector('.top-icon-btn[title="Toggle Theme"] i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            
            Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';
            renderCharts(); 
        }

        function processData(){
            const today=new Date();
            let maxDate = null; 
            rawData.forEach(r=>{
                r._dateObj=null; r._daysOld=0; r._fy = '';
                if(r.Date && r.Date.split('-').length===3){
                    const p=r.Date.split('-');
                    r._dateObj=new Date(p[2],p[1]-1,p[0]);
                    r._daysOld=Math.ceil(Math.abs(today-r._dateObj)/(1000*60*60*24));
                    if(!maxDate || r._dateObj > maxDate) maxDate = r._dateObj;
                    const month = r._dateObj.getMonth();
                    const year = r._dateObj.getFullYear();
                    const fyYear = (month >= 3) ? year + 1 : year;
                    r._fy = 'FY' + String(fyYear).slice(-2);
                }
                r._closedDateObj=null;
                if(r['Action Taken Date'] && r['Action Taken Date'].split('-').length===3) {
                     const p=r['Action Taken Date'].split('-');
                     r._closedDateObj=new Date(p[2],p[1]-1,p[0]);
                }
                r._drs=(r['DRS Status']||'').trim();
                r._act=(r['Action Status']||'').trim();
                r._saved = parseFloat(r['Hours Saved']) || 0; 
                r._zone = (r['ZONE'] && r['ZONE'].trim()) ? r['ZONE'].trim().toUpperCase() : (manualZoneMap[r.Plant] || 'OTHER');
                r._unit = (r['Org. Unit'] || 'Unknown').trim();
                let cu = (r['Closed Under']||'').trim().toUpperCase();
                if (cu.includes('TRUE') || cu === 'TP') r._closedUnder = 'TP';
                else if (cu.includes('FALSE POS') || cu === 'FP') r._closedUnder = 'FP';
                else if (cu.includes('FALSE NEG') || cu === 'FN') r._closedUnder = 'FN';
                else r._closedUnder = 'N/A';
            });
            if(maxDate) {
                const dateStr = maxDate.toLocaleDateString('en-GB'); 
                document.getElementById('lastUpdateDate').innerText = dateStr;
                document.getElementById('lastUpdateContainer').style.display = 'flex';
            }
            populateFYDropdown();
        }
        
        function populateFYDropdown() {
            const fys = new Set();
            rawData.forEach(r => { if(r._saved > 0 && r._fy) fys.add(r._fy); });
            const sortedFYs = Array.from(fys).sort().reverse();
            const sel = document.getElementById('optFY');
            sel.innerHTML = '';
            if(sortedFYs.length === 0) { sel.innerHTML = '<option value="">No Data</option>'; return; }
            sortedFYs.forEach(fy => { sel.innerHTML += `<option value="${fy}">${fy}</option>`; });
            sel.value = sortedFYs[0];
        }

        function setKPI(k){ activeKPI=k; document.querySelectorAll('.kpi-card').forEach(c=>c.classList.remove('active')); document.getElementById(`card-${k}`).classList.add('active'); applyFilters(); }
        function toggleFilter(k,v){ if(filters[k]===v) delete filters[k]; else filters[k]=v; applyFilters(); }

        function applyFilters(){
            let set=rawData;
            if(activeKPI==='Completed') set=set.filter(r=>r._drs==='Completed'&&r._act==='Completed');
            else if(activeKPI==='Pending') set=set.filter(r=>r._drs==='Action Pending'&&r._act==='Action Pending');
            else if(activeKPI==='Planned') set=set.filter(r=>r._drs==='Action Planned'&&r._act==='Action Planned');
            else if(activeKPI==='Open') set=set.filter(r=>(r._drs==='Action Pending'&&r._act==='Action Pending')||(r._drs==='Action Planned'&&r._act==='Action Planned'));

            filteredData=set.filter(r=>{
                for(const [k,v] of Object.entries(filters)){
                    if(k==='Age') {
                        if(r._drs === 'Completed') return false; 
                        if(v==='0-15 Days' && !(r._daysOld<=15)) return false;
                        if(v==='15-30 Days' && !(r._daysOld>15 && r._daysOld<=30)) return false;
                        if(v==='30-60 Days' && !(r._daysOld>30 && r._daysOld<=60)) return false;
                        if(v==='> 60 Days' && !(r._daysOld>60)) return false;
                    }
                    else if(k==='Zone'){if(r._zone!==v)return false;}
                    else if(k==='Unit'){if(r._unit!==v)return false;}
                    else if(k==='Fault'){ if(!r['Issue On Short']||!r['Issue On Short'].includes(v))return false; }
                    else if(k==='AreaComposite') {
                        const separatorIndex = v.indexOf(' - ');
                        if (separatorIndex === -1) return false;
                        const p = v.substring(0, separatorIndex);
                        const a = v.substring(separatorIndex + 3);
                        if (r.Plant !== p || r.Area !== a) return false;
                    }
                    else if(k==='Closed Under'){ if(r._closedUnder !== v) return false; }
                    else if(k==='Criticality'){ if(r['Criticality'] !== v) return false; }
                    else{if(r[k]!==undefined && r[k]!==v)return false;}
                }
                return true;
            });
            renderDashboard();
        }

        function renderDashboard(){ updateKPIs(); renderCharts(); renderWidgets(); renderFilterTags(); renderSidebar(); }

        function updateKPIs(){
            const ctx=rawData.filter(r=>{
                for(const [k,v] of Object.entries(filters)){
                    if(k==='Age') { if(r._drs === 'Completed') return false; if(v==='0-15 Days' && !(r._daysOld<=15)) return false; if(v==='15-30 Days' && !(r._daysOld>15 && r._daysOld<=30)) return false; if(v==='30-60 Days' && !(r._daysOld>30 && r._daysOld<=60)) return false; if(v==='> 60 Days' && !(r._daysOld>60)) return false; }
                    else if(k==='Zone'){if(r._zone!==v)return false;}
                    else if(k==='Unit'){if(r._unit!==v)return false;}
                    else if(k==='Fault'){ if(!r['Issue On Short']||!r['Issue On Short'].includes(v))return false; }
                    else if(k==='AreaComposite') {
                        const separatorIndex = v.indexOf(' - ');
                        if (separatorIndex === -1) return false;
                        const p = v.substring(0, separatorIndex);
                        const a = v.substring(separatorIndex + 3);
                        if (r.Plant !== p || r.Area !== a) return false;
                    }
                    else if(k==='Closed Under'){ if(r._closedUnder !== v) return false; }
                    else if(k==='Criticality'){ if(r['Criticality'] !== v) return false; }
                    else{if(r[k]!==undefined && r[k]!==v)return false;}
                }
                return true;
            });
            const c=(fn)=>ctx.filter(fn).length;
            document.getElementById('k-gen').innerText=ctx.length;
            document.getElementById('k-comp').innerText=c(r=>r._drs==='Completed'&&r._act==='Completed');
            document.getElementById('k-open').innerText=c(r=>(r._drs==='Action Pending'&&r._act==='Action Pending')||(r._drs==='Action Planned'&&r._act==='Action Planned'));
            document.getElementById('k-pend').innerText=c(r=>r._drs==='Action Pending'&&r._act==='Action Pending');
            document.getElementById('k-plan').innerText=c(r=>r._drs==='Action Planned'&&r._act==='Action Planned');
            window.actTakenCount=filteredData.filter(r=>(r._drs.includes('Pending')||r._drs.includes('Planned'))&&r._act==='Completed').length;
        }

        function renderCharts(){
            const data=filteredData;
            const agg=(k)=>{const m={};data.forEach(r=>{const v=r[k]||'N/A';m[v]=(m[v]||0)+1});return m;};
            
            const isDark = document.body.classList.contains('dark-mode');
            const txtColor = isDark ? '#cbd5e1' : '#475569';

            const colors = {
                red: '#f43f5e', orange: '#f59e0b', green: '#10b981', teal: '#14b8a6', 
                blue: '#3b82f6', purple: '#8b5cf6', slate: '#64748b'
            };

            const plants=[...new Set(data.map(r=>r.Plant))];
            drawChart('cDept', 'bar', {
                labels:plants,
                datasets:[
                    {label:'Critical',data:plants.map(p=>data.filter(r=>r.Plant===p&&r.Criticality==='Critical').length),backgroundColor:colors.red, stack:'0', borderRadius: 4, barPercentage: 0.6},
                    {label:'Marginal',data:plants.map(p=>data.filter(r=>r.Plant===p&&r.Criticality==='Marginal').length),backgroundColor:colors.orange, stack:'0', borderRadius: 4, barPercentage: 0.6}
                ]
            }, 'Plant', { scales: { x: { stacked: true }, y: { stacked: true, display: false } } });

            const cats=agg('Category');
            drawChart('cCat', 'bar', {
                labels:Object.keys(cats),
                datasets:[{data:Object.values(cats),backgroundColor:colors.teal,label:'Count', borderRadius: 50, barThickness: 20}]
            }, 'Category');

            const equips=agg('Type');
            drawChart('cEquip', 'bar', {
                labels:Object.keys(equips),
                datasets:[{data:Object.values(equips),backgroundColor:colors.slate,label:'Count',indexAxis: 'y', borderRadius: 50, barThickness: 15}]
            }, 'Type', { indexAxis: 'y' }); 

            // --- SPLIT CRITICALITY CHART ---
            const critCounts = {'Critical':0, 'Marginal':0, 'Normal':0};
            data.forEach(r => {
                const c = r.Criticality || 'Normal';
                if(c === 'Critical') critCounts['Critical']++;
                else if(c === 'Marginal') critCounts['Marginal']++;
                else critCounts['Normal']++;
            });
            document.getElementById('valTotalCrit').innerText = data.length;

            drawChart('cCrit', 'doughnut', {
                labels: ['Critical', 'Marginal', 'Normal'],
                datasets: [{ 
                    data: [critCounts['Critical'], critCounts['Marginal'], critCounts['Normal']], 
                    backgroundColor: [colors.red, colors.orange, colors.slate], 
                    borderWidth: 0, hoverOffset: 4 
                }]
            }, 'Criticality', { cutout: '75%', borderRadius: 20, plugins: { legend: { display: false }, datalabels: { display: false } } });

            const critLegend = document.getElementById('critLegendList');
            critLegend.innerHTML = '';
            const critItems = [
                { key: 'Critical', count: critCounts['Critical'], color: colors.red },
                { key: 'Marginal', count: critCounts['Marginal'], color: colors.orange },
                { key: 'Normal', count: critCounts['Normal'], color: colors.slate }
            ];
            critItems.forEach(item => {
                if(item.count > 0 || item.key !== 'Normal') {
                    const pct = data.length > 0 ? ((item.count / data.length) * 100).toFixed(1) + '%' : '0.0%';
                    const isActive = filters['Criticality'] === item.key;
                    const div = document.createElement('div');
                    div.className = `legend-item ${isActive ? 'active-filter' : ''}`;
                    div.innerHTML = `<div class="diag-info"><div class="legend-head">${item.key}</div><div><span class="legend-dot" style="background:${item.color}"></span><span class="legend-val" style="font-size:0.9rem;">${pct}</span></div></div><div class="legend-val">${item.count}</div>`;
                    div.onclick = () => toggleFilter('Criticality', item.key);
                    critLegend.appendChild(div);
                }
            });

            // Action Taken
            const actionTakenRows = data.filter(r=>(r._drs.includes('Pending')||r._drs.includes('Planned'))&&r._act==='Completed');
            const taken = actionTakenRows.length;
            const actionTakenNames = actionTakenRows.map(r => r['Equipment Name'] || 'Unknown');
            document.getElementById('valActTaken').innerText=taken;

            const centerEl = document.getElementById('valActTaken'); const centerDiv = centerEl.parentElement; 
            const showNames = () => { if(actionTakenNames.length > 0) { centerEl.style.fontSize = actionTakenNames.length > 2 ? '0.75rem' : '0.8rem'; centerEl.innerText = actionTakenNames.length > 2 ? actionTakenNames.slice(0, 2).join('\n') + `\n(+${actionTakenNames.length - 2})` : actionTakenNames.join('\n'); } };
            const showCount = () => { centerEl.style.fontSize = '2rem'; centerEl.innerText = taken; };
            centerDiv.onmouseenter = showNames; centerDiv.onmouseleave = showCount;

            drawChart('cDoughnut', 'doughnut', {
                labels:['Action Taken (Open)','Other'],
                datasets:[{data:[taken, data.length-taken],backgroundColor:[colors.teal, isDark ? '#1e293b' : '#e2e8f0'],borderWidth:0}]
            }, null, {
                cutout: '80%', borderRadius: 20,
                onHover: (e, elements) => { if (elements && elements.length > 0 && elements[0].index === 0) showNames(); else if(!centerDiv.matches(':hover')) showCount(); }
            });

            // --- TREND CHART WITH GRADIENT ---
            const dateSet = new Set(); const genMap = {}; const closedMap = {};
            data.forEach(r => { if(r.Date) { dateSet.add(r.Date); genMap[r.Date] = (genMap[r.Date]||0)+1; } if(r['Action Taken Date']) { dateSet.add(r['Action Taken Date']); closedMap[r['Action Taken Date']] = (closedMap[r['Action Taken Date']]||0)+1; } });
            const sortedDates = Array.from(dateSet).sort((a,b) => { const da = a.split('-').reverse().join(''); const db = b.split('-').reverse().join(''); return da.localeCompare(db); }).slice(-7);
            
            const ctxTrend = document.getElementById('cTrend').getContext('2d');
            const gradBlue = ctxTrend.createLinearGradient(0, 0, 0, 300);
            gradBlue.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); gradBlue.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
            const gradGreen = ctxTrend.createLinearGradient(0, 0, 0, 300);
            gradGreen.addColorStop(0, 'rgba(16, 185, 129, 0.5)'); gradGreen.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

            drawChart('cTrend', 'line', {
                labels: sortedDates,
                datasets: [
                    {label: 'Generated', data: sortedDates.map(d => genMap[d] || 0), borderColor: colors.blue, backgroundColor: gradBlue, fill: true, borderWidth: 3, pointRadius: 4, tension: 0.4},
                    {label: 'Closed', data: sortedDates.map(d => closedMap[d] || 0), borderColor: colors.green, backgroundColor: gradGreen, fill: true, borderWidth: 3, pointRadius: 4, tension: 0.4}
                ]
            }, null, { 
                plugins: { legend: { display: true, position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } } },
                scales: { y: { beginAtZero: true } }
            });

            // Top 10 Bad Actors
            const eqCounts = {}; data.filter(r => r._drs !== 'Completed').forEach(r => { const n = r['Equipment Name']; if(n) eqCounts[n] = (eqCounts[n] || 0) + 1; });
            const top10 = Object.entries(eqCounts).sort((a,b) => b[1]-a[1]).slice(0, 10);
            drawChart('cTopEquip', 'bar', {
                labels: top10.map(i => i[0]), 
                datasets: [{ label: 'Open Faults', data: top10.map(i => i[1]), backgroundColor: colors.red, indexAxis: 'y', borderRadius: 50, barThickness: 12 }]
            }, 'Equipment Name', { indexAxis: 'y', layout: { padding: { left: 0 } }, scales: { x: { display: false }, y: { display: true, grid: { display: false } } } });

            // Top 5 Areas
            const areaCounts = {}; data.forEach(r => { const key = `${r.Plant || 'Unknown'} - ${r.Area || 'Unknown'}`; areaCounts[key] = (areaCounts[key] || 0) + 1; });
            const top5Areas = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            drawChart('cTopArea', 'bar', {
                labels: top5Areas.map(i => i[0]),
                datasets: [{ label: 'Reports', data: top5Areas.map(i => i[1]), backgroundColor: colors.orange, indexAxis: 'y', borderRadius: 50, barThickness: 15 }]
            }, 'AreaComposite', { indexAxis: 'y', layout: { padding: { left: 0 } }, scales: { x: { display: false }, y: { display: true } } });

            // Interactive Diagnosis Split
            const closedUnderCounts = { 'TP': 0, 'FP': 0, 'FN': 0 }; let totalClosedUnder = 0;
            data.forEach(r => { if (r._closedUnder && r._closedUnder !== 'N/A') { closedUnderCounts[r._closedUnder]++; totalClosedUnder++; } });
            document.getElementById('valClosedUnder').innerText = totalClosedUnder;

            drawChart('cClosedUnder', 'doughnut', {
                labels: ['TP', 'FP', 'FN'],
                datasets: [{ data: [closedUnderCounts['TP'], closedUnderCounts['FP'], closedUnderCounts['FN']], backgroundColor: [colors.green, colors.orange, colors.red], borderWidth: 0, hoverOffset: 4 }]
            }, 'Closed Under', { cutout: '75%', borderRadius: 20, plugins: { legend: { display: false }, datalabels: { display: false } } });

            const legendContainer = document.getElementById('diagnosisLegendList'); legendContainer.innerHTML = ''; 
            const diagItems = [
                { key: 'TP', label: 'True Positive', count: closedUnderCounts['TP'], color: colors.green },
                { key: 'FP', label: 'False Positive', count: closedUnderCounts['FP'], color: colors.orange },
                { key: 'FN', label: 'False Negative', count: closedUnderCounts['FN'], color: colors.red }
            ];
            diagItems.forEach(item => {
                const pct = totalClosedUnder > 0 ? ((item.count / totalClosedUnder) * 100).toFixed(1) + '%' : '0.0%';
                const isActive = filters['Closed Under'] === item.key;
                const div = document.createElement('div');
                div.className = `legend-item ${isActive ? 'active-filter' : ''}`;
                div.innerHTML = `<div class="diag-info"><div class="legend-head">${item.key}</div><div><span class="legend-dot" style="background:${item.color}"></span><span class="legend-val" style="font-size:0.9rem;">${pct}</span></div></div><div class="legend-val">${item.count}</div>`;
                div.onclick = () => toggleFilter('Closed Under', item.key);
                legendContainer.appendChild(div);
            });
            
            renderSavedChart();
        }

        function renderSavedChart() {
            const selectedFY = document.getElementById('optFY').value;
            const fyData = filteredData.filter(r => r._fy === selectedFY && r._saved > 0);
            const monthOrder = ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'];
            const savedByMonth = new Array(12).fill(0);
            let totalSaved = 0;
            fyData.forEach(r => { if(r._dateObj) { let mIndex = r._dateObj.getMonth(); let sortIndex = (mIndex >= 3) ? mIndex - 3 : mIndex + 9; savedByMonth[sortIndex] += r._saved; totalSaved += r._saved; } });
            document.getElementById('valTotalSaved').innerText = totalSaved + 'h';
            const ctx = document.getElementById('cSaved').getContext('2d');
            if(savedChartInstance) savedChartInstance.destroy();
            const txtColor = document.body.classList.contains('dark-mode') ? '#cbd5e1' : '#64748b';
            savedChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: monthOrder, datasets: [{ label: 'Hours Saved', data: savedByMonth, backgroundColor: '#8b5cf6', borderRadius: 50, barThickness: 15 }] },
                plugins: [ChartDataLabels],
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: txtColor, anchor: 'end', align: 'top', formatter: (v) => v > 0 ? v : '' } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });
        }

        function drawChart(id, type, data, filterKey, extraOptions={}){
            const ctx = document.getElementById(id).getContext('2d');
            if(charts[id]) charts[id].destroy();
            const defaultScales = (type === 'doughnut') ? {} : { x: { display: extraOptions.indexAxis !== 'y', grid: { display:false } }, y: { display: extraOptions.indexAxis === 'y', grid: { display:false } } };
            const scales = extraOptions.scales || defaultScales;

            charts[id] = new Chart(ctx, {
                type: type, data: data, plugins: [ChartDataLabels],
                options: {
                    ...extraOptions, responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'nearest', axis: extraOptions.indexAxis === 'y' ? 'y' : 'x', intersect: true },
                    plugins: {
                        legend: { display: type !== 'bar' && type !== 'doughnut' },
                        datalabels: {
                            color: document.body.classList.contains('dark-mode') ? '#fff' : '#333',
                            font: { weight: 'bold', size: 10 },
                            display: (ctx) => ctx.dataset.data[ctx.dataIndex] > 0,
                            align: type === 'line' ? 'top' : 'center',
                            formatter: (v) => v
                        },
                        ...(extraOptions.plugins || {})
                    },
                    scales: scales,
                    onClick: (e, el) => { if (el.length && filterKey) { const idx = el[0].index; const val = (extraOptions.filterValues) ? extraOptions.filterValues[idx] : data.labels[idx]; toggleFilter(filterKey, val); } },
                    onHover: (e, el) => { e.native.target.style.cursor = el[0] ? 'pointer' : 'default'; if(extraOptions.onHover) extraOptions.onHover(e, el); }
                }
            });
        }

        function renderWidgets(){
            const faults={}; filteredData.forEach(r=>{ if(r['Issue On Short']) r['Issue On Short'].split(',').forEach(i=>{const x=i.trim(); if(x) faults[x]=(faults[x]||0)+1;}); });
            const fList=document.getElementById('faultList'); fList.innerHTML='';
            Object.entries(faults).sort((a,b)=>b[1]-a[1]).forEach(([f,c])=>{
                let icon='fa-triangle-exclamation'; for(const [k,v] of Object.entries(ICONS))if(f.includes(k))icon=v;
                fList.innerHTML+=`<div class="fault-pill ${filters['Fault']===f?'active':''}" onclick="toggleFilter('Fault','${f}')"><span><i class="fas ${icon}" style="margin-right:8px; opacity:0.7;"></i>${f}</span><b>${c}</b></div>`;
            });

            const buckets={'0-15 Days':0,'15-30 Days':0,'30-60 Days':0,'> 60 Days':0};
            filteredData.forEach(r=>{ if(r._drs!=='Completed'){ if(r._daysOld<=15)buckets['0-15 Days']++; else if(r._daysOld<=30)buckets['15-30 Days']++; else if(r._daysOld<=60)buckets['30-60 Days']++; else buckets['> 60 Days']++; } });
            const tAge=document.getElementById('tAge'); tAge.innerHTML='';
            const palette = ['#10b981', '#f59e0b', '#f43f5e', '#881337'];
            Object.entries(buckets).forEach(([k,v],i)=>{
                if(v>0) {
                    const activeClass = filters['Age'] === k ? 'active' : '';
                    tAge.innerHTML+=`<tr class="age-row ${activeClass}" onclick="toggleFilter('Age', '${k}')"><td><i class="fas fa-circle" style="color:${palette[i]}; font-size:0.6rem; margin-right:8px;"></i>${k}</td><td style="text-align:right; font-weight:700;">${v}</td></tr>`;
                }
            });

            let ana = 0, ai = 0;
            filteredData.forEach(r => { const val = (r['Isssued By'] || r['Report Issued By'] || '').trim(); if(val.toLowerCase().endsWith('@infinite-uptime.com')) ana++; else if(val.toUpperCase().includes('NITY')) ai++; });
            document.getElementById('valAnalyst').innerText = ana; document.getElementById('valAI').innerText = ai;

            // --- FIXED: Action Registry (No Bold Tags) ---
            const tbody=document.querySelector('#tList tbody'); tbody.innerHTML='';
            filteredData.slice(0,50).forEach(r=>{
                let trendIcon = ''; const trendVal = (r.Trend || '').toLowerCase();
                if(trendVal.includes('increas')) trendIcon = '<i class="fas fa-arrow-trend-up" style="color:var(--accent-red); margin-left:5px;"></i>';
                else if(trendVal.includes('decreas')) trendIcon = '<i class="fas fa-arrow-trend-down" style="color:var(--accent-green); margin-left:5px;"></i>';
                else if(trendVal.includes('stable')) trendIcon = '<i class="fas fa-minus" style="color:var(--text-muted); margin-left:5px; font-size:0.7rem;"></i>';
                
                // Using font-weight: 600 instead of <b>
                tbody.innerHTML+=`
                    <tr>
                        <td>${r.Date}</td>
                        <td>${r.Plant}</td>
                        <td style="font-weight:600; color:var(--text-main);">${r['Equipment Name']} ${trendIcon}</td>
                        <td style="font-weight:600; color:var(--text-main);">${r['Recommended Actions']}</td>
                        <td style="color:var(--text-muted); font-size:0.75rem;">${r['Remarks'] || '-'}</td>
                    </tr>`;
            });
        }

        function renderSidebar(){
            const units = {}; rawData.forEach(r=> { if(r._unit && r._unit !=='Unknown') units[r._unit] = (units[r._unit]||0)+1; });
            const uCont = document.getElementById('unitListContainer'); uCont.innerHTML = '';
            Object.keys(units).sort().forEach(u => {
                uCont.innerHTML += `<div class="filter-card unit-card ${filters['Unit']===u?'active':''}" onclick="toggleFilter('Unit','${u}')"><div class="icon-box"><i class="fas fa-building-columns unit-icon"></i></div><div class="card-info"><span class="card-name">${u}</span><span class="card-count">${units[u]} Reports</span></div></div>`;
            });
            const zones={}; rawData.filter(r => !filters['Unit'] || r._unit === filters['Unit']).forEach(r=>zones[r._zone]=(zones[r._zone]||0)+1);
            const cont=document.getElementById('zoneListContainer'); cont.innerHTML='';
            Object.keys(zones).sort().forEach(z=>{
                let cls='', icon='fa-industry';
                if(z.includes('IRON')){cls='zone-iron';icon='fa-fire';} else if(z.includes('STEEL')){cls='zone-steel';icon='fa-layer-group';} else if(z.includes('PROCESS')){cls='zone-process';icon='fa-gears';}
                cont.innerHTML+=`<div class="filter-card zone-card ${cls} ${filters['Zone']===z?'active':''}" onclick="toggleFilter('Zone','${z}')"><div class="icon-box"><i class="fas ${icon}"></i></div><div class="card-info"><span class="card-name">${z}</span><span class="card-count">${zones[z]} Reports</span></div></div>`;
            });
        }

        function renderFilterTags(){
            const c=document.getElementById('activeFilters'); c.innerHTML='';
            Object.entries(filters).forEach(([k,v])=>{c.innerHTML+=`<div class="filter-tag">${k}: ${v} <i class="fas fa-xmark" style="cursor:pointer; opacity:0.8;" onclick="toggleFilter('${k}','${v}')"></i></div>`;});
        }
        function checkAutoMap(){ const p=[...new Set(rawData.map(r=>r.Plant))].sort(); const c=document.getElementById('mappingContainer'); c.innerHTML=''; p.forEach(pl=>{ const cur=manualZoneMap[pl]||''; let o=`<option value="">Use CSV Default</option>`; ZONES_DEFAULT.forEach(z=>o+=`<option value="${z}" ${cur===z?'selected':''}>${z}</option>`); c.innerHTML+=`<div class="map-row"><span>${pl}</span><select id="map_${pl}">${o}</select></div>`; }); }
        function openSettings(){document.getElementById('settingsModal').style.display='flex';}
        function closeSettings(){document.getElementById('settingsModal').style.display='none';}
        function saveMappings(){ document.querySelectorAll('[id^="map_"]').forEach(i=>{if(i.value)manualZoneMap[i.id.replace('map_','')]=i.value;else delete manualZoneMap[i.id.replace('map_','')];}); localStorage.setItem('mtr_manual_map',JSON.stringify(manualZoneMap)); closeSettings(); processData(); renderSidebar(); applyFilters(); }

        function initTimelineFilters() {
            const plants = [...new Set(rawData.map(r => r.Plant))].sort();
            const pSelect = document.getElementById('tl-plant'); pSelect.innerHTML = '<option value="">Select Plant...</option>';
            plants.forEach(p => pSelect.innerHTML += `<option value="${p}">${p}</option>`);
        }
        function filterTimelineEquipment() {
            const selectedPlant = document.getElementById('tl-plant').value;
            const eSelect = document.getElementById('tl-equip'); eSelect.innerHTML = '<option value="">Select Equipment...</option>';
            if (!selectedPlant) return;
            const equips = [...new Set(rawData.filter(r => r.Plant === selectedPlant).map(r => r['Equipment Name']))].sort();
            equips.forEach(e => eSelect.innerHTML += `<option value="${e}">${e}</option>`);
        }
        function renderTimeline() {
            const plant = document.getElementById('tl-plant').value; const equip = document.getElementById('tl-equip').value;
            const container = document.getElementById('timeline-container');
            if (!plant || !equip) { container.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:30px;">Select a Plant and Equipment to view history.</div>'; return; }
            const history = rawData.filter(r => r.Plant === plant && r['Equipment Name'] === equip);
            history.sort((a, b) => (b._dateObj || 0) - (a._dateObj || 0));
            container.innerHTML = '';
            if (history.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px;">No records found.</div>'; return; }
            history.forEach(r => {
                const critClass = (r.Criticality === 'Critical') ? 'critical' : (r.Criticality === 'Marginal' ? 'marginal' : '');
                let actionHTML = '';
                if (r['Corrective Action Taken']) { actionHTML = `<div class="tl-action-box"><div class="tl-action-date">Action Taken: ${r['Action Taken Date'] || 'Unknown Date'}</div><div class="tl-action-text">${r['Corrective Action Taken']}</div></div>`; }
                
                // --- FIXED: Timeline Date Layout ---
                container.innerHTML += `
                    <div class="tl-item ${critClass}">
                        <span class="tl-dot"></span>
                        <div class="tl-content">
                            <div class="tl-date">
                                <span><i class="far fa-calendar"></i> ${r.Date}</span>
                                <span style="font-size:0.75rem; text-transform:uppercase; font-weight:700; color:var(--text-main);">${r.Criticality || 'Normal'}</span>
                            </div>
                            <div class="tl-obs" style="margin-top:5px; font-size:1.1rem;">${r.Observation || 'No Observation'}</div>
                            <div class="tl-rec" style="margin-top:5px; color:var(--text-muted);"><i class="fas fa-screwdriver-wrench" style="margin-right:5px;"></i> ${r['Recommended Actions'] || 'No Recommendation'}</div>
                            ${actionHTML}
                        </div>
                    </div>`;
            });
        }

        async function exportPDF() {
            document.body.classList.add('print-mode'); window.dispatchEvent(new Event('resize'));
            await new Promise(resolve => setTimeout(resolve, 800));
            const element = document.querySelector('.main');
            const orientation = (currentView === 'dashboard') ? 'landscape' : 'portrait';
            const opt = { margin: 5, filename: currentView === 'dashboard' ? 'MTR_Analytics.pdf' : 'Equipment_History.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: orientation }, pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } };
            await html2pdf().set(opt).from(element).save();
            document.body.classList.remove('print-mode'); window.dispatchEvent(new Event('resize'));
        }
    </script>
</body>
</html>
