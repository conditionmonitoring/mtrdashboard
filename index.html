<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTR Analytics Suite v5.9 (Compact)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- LIQUID GLASS THEME VARIABLES --- */
            --font-main: 'Plus Jakarta Sans', sans-serif;

            /* Light Mode Glass Colors */
            --glass-base: rgba(255, 255, 255, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-highlight: rgba(255, 255, 255, 0.95);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            
            /* Text & UI */
            --text-main: #1e293b;     
            --text-muted: #64748b;    
            --border-color: rgba(203, 213, 225, 0.8);  
            
            /* Accents */
            --accent-teal: #0d9488;      --accent-teal-soft: rgba(13, 148, 136, 0.15); 
            --accent-blue: #2563eb;      --accent-blue-soft: rgba(37, 99, 235, 0.15); 
            --accent-red: #e11d48;       --accent-red-soft: rgba(225, 29, 72, 0.15);  
            --accent-green: #059669;     --accent-green-soft: rgba(5, 150, 105, 0.15);
            --accent-amber: #d97706;     --accent-amber-soft: rgba(217, 119, 6, 0.15);
            --accent-purple: #7c3aed;    --accent-purple-soft: rgba(124, 58, 237, 0.15);
        }

        /* Dark Mode Glass */
        body.dark-mode {
            color-scheme: dark;
            --glass-base: rgba(15, 23, 42, 0.70);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(30, 41, 59, 0.9);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);

            --text-main: #f1f5f9;     
            --text-muted: #94a3b8;    
            --border-color: rgba(255, 255, 255, 0.15); 
        }

        /* Global Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font-main); scrollbar-width: thin; scrollbar-color: var(--text-muted) transparent; }
        
        /* Floating Scrollbar (Webkit) */
        *::-webkit-scrollbar { width: 6px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background-color: var(--text-muted); border-radius: 20px; border: 2px solid transparent; background-clip: content-box; }
        *::-webkit-scrollbar-thumb:hover { background-color: var(--text-main); }
        
        body { 
            display: flex; 
            background-color: #f1f5f9; 
            height: 100dvh; overflow: hidden; 
            font-size: 13px; /* Slightly reduced base font */
            color: var(--text-main); 
            transition: color 0.3s ease;
        }
        body.dark-mode { background-color: #0f172a; }

        /* --- LIQUID BACKGROUND ANIMATION --- */
        .ambient-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: drift 20s infinite alternate; }
        .b1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #cffafe; animation-duration: 25s; }
        .b2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: #e0e7ff; animation-duration: 30s; animation-delay: -5s; }
        .b3 { top: 40%; left: 40%; width: 30vw; height: 30vw; background: #fce7f3; animation-duration: 22s; animation-delay: -10s; }
        body.dark-mode .b1 { background: #115e59; opacity: 0.25; } 
        body.dark-mode .b2 { background: #1e3a8a; opacity: 0.25; } 
        body.dark-mode .b3 { background: #831843; opacity: 0.2; } 
        @keyframes drift { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(50px, 70px) scale(1.1); } }

        /* --- COMPONENTS --- */
        .sidebar { width: 260px; background: var(--glass-base); backdrop-filter: blur(20px); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); flex-shrink: 0; z-index: 100; height: 100dvh; }
        .sidebar.desktop-closed { width: 0; overflow: hidden; border: none; }
        
        .sidebar-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; margin-bottom: 5px; flex-shrink: 0; }
        .sidebar-logo { max-height: 28px; max-width: 90px; object-fit: contain; }
        .tata-logo { max-height: 40px; max-width: 120px; object-fit: contain; }
        .sidebar-close-btn { background: transparent; border: none; color: var(--text-muted); width: 32px; height: 32px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .sidebar-close-btn:hover { background: var(--glass-border); color: var(--text-main); }

        .nav-section { padding: 0 15px; flex-shrink: 0; }
        .nav-label { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); margin: 15px 0 8px 5px; text-transform: uppercase; letter-spacing: 0.05em; }
        .nav-item { padding: 10px 14px; margin-bottom: 6px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 12px; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; transition: all 0.2s ease; }
        .nav-item:hover { background: var(--glass-border); color: var(--text-main); }
        .nav-item.active { background: linear-gradient(135deg, var(--accent-teal), #0f766e); color: white; box-shadow: 0 4px 15px -3px rgba(13, 148, 136, 0.4); }

        .sidebar-content { padding: 0 15px 20px 15px; overflow-y: auto; flex-grow: 1; min-height: 0; }

        .filter-card { background: rgba(255,255,255,0.4); border: 1px solid var(--border-color); border-radius: 10px; padding: 8px 10px; margin-bottom: 6px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s; }
        body.dark-mode .filter-card { background: rgba(255,255,255,0.05); } 
        .filter-card:hover { transform: translateX(4px); background: var(--glass-highlight); }
        .filter-card.active { background: var(--glass-highlight); border-color: var(--accent-teal); box-shadow: var(--glass-shadow); }
        
        .icon-box { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; margin-right: 10px; flex-shrink: 0; background: rgba(0,0,0,0.05); color: var(--text-muted); }
        body.dark-mode .icon-box { background: rgba(255,255,255,0.1); }
        .unit-card.active .icon-box { background: var(--accent-blue); color: white; }
        .zone-card.active .icon-box { background: var(--accent-teal); color: white; }
        .card-name { font-weight: 600; font-size: 0.85rem; display: block; color: var(--text-main); }
        .card-count { font-size: 0.7rem; color: var(--text-muted); }

        .sidebar-footer { margin-top: auto; padding: 15px; border-top: 1px solid var(--glass-border); flex-shrink: 0; }
        
        .side-btn { width: 100%; padding: 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px; transition: 0.2s; font-size: 0.85rem; backdrop-filter: blur(4px); }
        .btn-upload-side { background: var(--accent-teal); color: white; box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3); }
        .btn-upload-side:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-reset-side { background: var(--accent-red-soft); color: var(--accent-red); border: 1px solid transparent; }
        .btn-reset-side:hover { background: var(--accent-red); color: white; }
        .footer-credits { text-align: center; color: var(--text-muted); font-size: 0.65rem; margin-top: 10px; opacity: 0.8; }
        .dev-name { color: var(--accent-teal); font-weight: 700; }

        .main { flex-grow: 1; display: flex; flex-direction: column; overflow-y: auto; position: relative; width: 100%; }
        
        /* --- COMPACT TOP BAR --- */
        .top-bar { 
            background: var(--glass-base); backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border); 
            padding: 0 20px; /* Reduced padding */
            display: flex; align-items: center; justify-content: space-between; 
            position: sticky; top: 0; z-index: 40; flex-shrink: 0; 
            height: 48px; /* Reduced from 60px */
        }
        .top-left { display: flex; align-items: center; flex-grow: 1; overflow: hidden; }
        .page-header-title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); margin-right: 15px; letter-spacing: -0.03em; white-space: nowrap; text-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .top-icon-btn { background:transparent; border:none; cursor:pointer; font-size:1rem; color: var(--text-muted); margin-left:8px; padding: 6px; border-radius: 8px; transition: 0.2s; }
        .top-icon-btn:hover { background: var(--glass-border); color: var(--accent-teal); }
        .last-update { background: var(--glass-border); color: var(--text-main); padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; margin-right: 10px; border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 6px; }
        .last-update i { color: var(--accent-teal); }
        
        .filters-active { display: flex; gap: 6px; margin-left: 0; overflow-x: auto; padding-bottom: 0; align-items: center; height: 100%; }
        .filter-tag { background: #1e293b; color: #fff; padding: 3px 10px; border-radius: 15px; font-size: 0.7rem; font-weight: 600; display: flex; align-items: center; gap: 5px; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.15); cursor: pointer; transition: 0.2s; }
        body.dark-mode .filter-tag { background: rgba(13, 148, 136, 0.2); color: #5eead4; border: 1px solid rgba(13, 148, 136, 0.4); box-shadow: 0 0 10px rgba(13, 148, 136, 0.1); }
        .filter-tag:hover { transform: translateY(-1px); opacity: 0.9; }

        /* --- COMPACT KPI CONTAINER --- */
        .top-stats-container { 
            display: flex; gap: 10px; 
            padding: 10px 20px 5px 20px; /* Reduced Padding */
            flex-wrap: wrap; position: sticky; top: 48px; z-index: 30; 
            background: var(--glass-base); border-bottom: 1px solid var(--glass-border); backdrop-filter: blur(16px); 
        }
        .kpi-row { flex-grow: 1; display: flex; gap: 10px; flex-wrap: wrap; }
        
        .kpi-card, .d-card, .issuer-card { background: var(--glass-base); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); box-shadow: var(--glass-shadow); border-radius: 16px; }
        
        /* COMPACT KPI CARD */
        .kpi-card { 
            flex: 1 1 120px; 
            padding: 8px 12px; /* Reduced Padding */
            cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; 
            min-height: 55px; /* Reduced from 70px */
            display: flex; flex-direction: column; justify-content: center; 
        }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 30px 0 rgba(31, 38, 135, 0.1); border-color: var(--glass-highlight); }
        .kpi-card.active { border-color: currentColor; background: linear-gradient(145deg, var(--glass-base), var(--glass-highlight)); }
        
        .kpi-icon-bg { 
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%); 
            width: 32px; height: 32px; /* Smaller Icon */
            border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; 
        }
        .k-gen .kpi-icon-bg { background: rgba(100, 116, 139, 0.1); color: var(--text-muted); }
        .k-comp .kpi-icon-bg { background: var(--accent-green-soft); color: var(--accent-green); }
        .k-open .kpi-icon-bg { background: var(--accent-amber-soft); color: var(--accent-amber); }
        .k-pend .kpi-icon-bg { background: var(--accent-red-soft); color: var(--accent-red); }
        .k-plan .kpi-icon-bg { background: var(--accent-blue-soft); color: var(--accent-blue); }

        .kpi-title { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7; margin-bottom: 0px; }
        .kpi-num { font-size: 1.4rem; font-weight: 800; line-height: 1.1; letter-spacing: -0.03em; } /* Slightly smaller number */
        
        .issuer-card { 
            flex: 0 0 160px; 
            padding: 8px 12px; 
            display: flex; flex-direction: column; justify-content: center; 
            min-height: 55px; /* Compact */
        }
        .issuer-header { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; letter-spacing: 0.1em; border-bottom: 1px solid var(--border-color); padding-bottom: 2px; }
        .issuer-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; font-size: 0.75rem; }
        .issuer-val { font-weight: 700; color: var(--text-main); font-size: 0.8rem; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 15px 20px 30px 20px; }
        .d-card { padding: 14px; display: flex; flex-direction: column; min-width: 0; width: 100%; height: 100%; transition: transform 0.3s ease; }
        .d-card:hover { transform: translateY(-2px); box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.1); }
        .card-head { font-size: 0.9rem; font-weight: 700; color: var(--text-main); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .card-head small { font-weight: 500; color: var(--text-muted); font-size: 0.7rem; }

        .chart-box { position: relative; width: 100%; flex-grow: 1; min-height: 0; } 
        canvas { width: 100% !important; height: 100% !important; }
        .cb-standard { height: 140px; } .cb-tall { height: 260px; }     
        .a-dept { grid-column: span 2; } .a-cat { grid-column: span 1; } .a-equip { grid-column: span 1; } 
        .a-crit { grid-column: span 1; } .a-age { grid-column: span 1; } .a-act-taken { grid-column: span 1; } 
        .a-top-equip { grid-column: span 1; grid-row: span 2; } 
        .a-fault { grid-column: span 1; } .a-closed-under { grid-column: span 1; } .a-top-area { grid-column: span 1; }
        .a-trend { grid-column: span 2; } .a-saved { grid-column: span 2; } 
        .a-list { grid-column: span 4; height: 380px; overflow: hidden; } 

        .chart-split-wrapper { display: flex; align-items: center; height: 100%; padding: 0 5px; gap: 15px; }
        .chart-split-left { position: relative; width: 45%; height: 135px; display: flex; justify-content: center; align-items: center; }
        .chart-split-right { width: 55%; display: flex; flex-direction: column; gap: 6px; justify-content: center; }
        
        .legend-item { background: rgba(255,255,255,0.1); border:1px solid var(--border-color); border-radius: 8px; padding: 4px 8px; margin-bottom: 3px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s; }
        .legend-item:hover { transform: scale(1.02); background: var(--glass-highlight); }
        .legend-item.active-filter { border-color: var(--text-main); box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: var(--glass-highlight); }
        .legend-head { font-size: 0.75rem; font-weight: 700; color: var(--text-main); }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .legend-val { font-size: 0.85rem; font-weight: 800; color: var(--text-main); }

        .fault-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; height: 100%; overflow-y: auto; padding-right: 4px; align-content: start; }
        .fault-pill { 
            background: rgba(255,255,255,0.4);
            padding: 5px 8px; font-size: 0.75rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; color: var(--text-main); font-weight: 500; transition: 0.2s; border: 1px solid transparent; 
        }
        body.dark-mode .fault-pill { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.1); }
        .fault-pill:hover, .fault-pill.active { background: var(--accent-teal-soft); color: var(--accent-teal); border-color: var(--accent-teal); }
        .fault-pill b { background: rgba(0,0,0,0.1); padding: 1px 6px; border-radius: 6px; font-size: 0.7rem; color: var(--text-main); }
        body.dark-mode .fault-pill b { background: rgba(255,255,255,0.15); color: #fff; }

        .age-row { cursor: pointer; transition: 0.2s; color: var(--text-main); border-radius: 8px; } 
        .age-row td { padding: 6px 8px; font-size: 0.8rem; border-bottom: 1px solid var(--border-color); }
        .age-row:hover { background: var(--glass-border); } .age-row.active { box-shadow: inset 4px 0 0 var(--accent-teal); background: var(--glass-border); font-weight: 700; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; } 
        th { text-align: left; padding: 10px; background: transparent; position: sticky; top: 0; z-index: 10; color: var(--text-muted); font-weight: 700; border-bottom: 2px solid var(--border-color); backdrop-filter: blur(4px); } 
        td { padding: 8px 10px; border-bottom: 1px solid var(--border-color); color: var(--text-main); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        
        .table-search { width: 100%; padding: 8px 12px; margin-bottom: 10px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.2); color: var(--text-main); border-radius: 8px; font-size: 0.85rem; outline: none; transition: 0.2s; }
        .table-search:focus { border-color: var(--accent-teal); background: var(--glass-highlight); box-shadow: 0 0 0 3px var(--accent-teal-soft); }
        .pending-badge { padding: 3px 6px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .pb-critical { background: var(--accent-red-soft); color: var(--accent-red); }
        .pb-warning { background: var(--accent-amber-soft); color: var(--accent-amber); }
        .pb-safe { background: var(--accent-green-soft); color: var(--accent-green); }
        .donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; } 
        .dc-val { font-size: 1.8rem; font-weight: 800; color: var(--text-main); line-height: 1; letter-spacing: -0.02em; }
        .view-section { display: none; }
        .view-section.active-view { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Timeline */
        .timeline-wrapper { padding: 20px 30px; max-width: 1000px; margin: 0 auto; }
        .tl-controls { display: flex; gap: 15px; margin-bottom: 25px; background: var(--glass-base); padding: 15px; border-radius: 16px; box-shadow: var(--glass-shadow); border: 1px solid var(--glass-border); backdrop-filter: blur(12px); }
        
        /* DROPDOWN FIX FOR DARK MODE */
        .tl-select { padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; flex-grow: 1; font-size: 0.9rem; background: rgba(255,255,255,0.3); color: var(--text-main); outline: none; cursor: pointer; }
        body.dark-mode .tl-select { background: rgba(0, 0, 0, 0.3); border-color: rgba(255, 255, 255, 0.2); color: var(--text-main); }
        .tl-select option { background-color: var(--glass-base); color: #333; }
        body.dark-mode .tl-select option { background-color: #0f172a; color: #f1f5f9; }

        .timeline-container { position: relative; }
        .timeline-container::after { content: ''; position: absolute; width: 2px; background-color: var(--border-color); top: 10px; bottom: 0; left: 24px; }
        .tl-item { padding: 0 0 25px 50px; position: relative; }
        .tl-dot { position: absolute; width: 14px; height: 14px; left: 18px; background-color: var(--glass-base); border: 3px solid var(--accent-teal); top: 4px; border-radius: 50%; z-index: 2; box-shadow: 0 0 0 4px var(--glass-base); }
        .tl-item.critical .tl-dot { border-color: var(--accent-red); }
        .tl-item.marginal .tl-dot { border-color: var(--accent-amber); }
        .tl-content { padding: 16px; background-color: var(--glass-base); border-radius: 16px; box-shadow: var(--glass-shadow); border: 1px solid var(--glass-border); transition: 0.3s; backdrop-filter: blur(12px); }
        .tl-content:hover { transform: translateY(-2px); border-color: var(--accent-teal); }
        
        .tl-action-box { background: var(--accent-teal-soft); padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 3px solid var(--accent-teal); }
        
        .tl-date { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 6px; }

        /* Modal Layout */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; }
        
        #detailModal .modal-box { 
            width: 800px; max-width: 95%; max-height: 85vh; 
            background: var(--glass-base); 
            border: 1px solid var(--glass-border); 
            backdrop-filter: blur(30px); 
            box-shadow: 0 25px 60px rgba(0,0,0,0.5); 
            border-radius: 24px; 
            padding: 0; 
            display: flex; flex-direction: column; 
            overflow: hidden; 
        }

        .modal-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.1); 
        }

        .modal-scroll-content {
            padding: 25px; 
            overflow-y: auto; 
            flex-grow: 1; 
        }

        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 0; }
        .detail-item { 
            background: rgba(255,255,255,0.4); 
            padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); 
        }
        body.dark-mode .detail-item { background: rgba(0, 0, 0, 0.25); }
        
        .detail-label { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 4px; letter-spacing: 0.05em; }
        .detail-value { font-size: 0.9rem; font-weight: 600; color: var(--text-main); word-break: break-word; }
        .detail-full { grid-column: span 2; }
        .detail-obs { background: var(--accent-red-soft); color: var(--accent-red); border-color: transparent; }
        .detail-rec { background: var(--accent-green-soft); color: var(--accent-green); border-color: transparent; }

        @media (max-width: 1200px) {
            .dashboard-grid { grid-template-columns: 1fr 1fr; }
            .a-dept, .a-trend, .a-list, .a-saved { grid-column: span 2; }
            .a-top-equip { grid-row: auto; }
            .chart-split-wrapper { flex-direction: column; }
            .chart-split-left, .chart-split-right { width: 100%; }
        }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; } .sidebar.mobile-active { left: 0; }
            .dashboard-grid { grid-template-columns: 1fr; padding: 15px; } 
            .a-dept, .a-cat, .a-act-taken, .a-equip, .a-crit, .a-age, .a-fault, .a-list, .a-top-equip, .a-top-area, .a-trend, .a-closed-under, .a-saved { grid-column: span 1; grid-row: auto; }
            .top-stats-container { padding: 15px; } .kpi-row { gap: 10px; } .kpi-card { flex: 1 1 100%; }
            .detail-grid { grid-template-columns: 1fr; } .detail-full { grid-column: span 1; }
        }
    </style>
</head>
<body>
    
    <div class="ambient-background">
        <div class="blob b1"></div>
        <div class="blob b2"></div>
        <div class="blob b3"></div>
    </div>

    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="settingsModal" class="modal">
        <div class="modal-box" style="width:500px;">
            <div class="modal-header">
                <h3 style="margin:0; font-weight:800;">⚙️ Zone Configuration</h3>
                <button onclick="closeSettings()" style="background:none; border:none; color:var(--text-muted); font-size:1.2rem; cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-scroll-content">
                <div id="mappingContainer"></div>
                <button class="btn-save side-btn btn-upload-side" style="margin-top:20px;" onclick="saveMappings()">Save Configuration</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-box">
            <div class="modal-header">
                <h3 style="margin:0; font-weight:800; display:flex; align-items:center; gap:12px; font-size:1.1rem;">
                    <i class="fas fa-file-invoice" style="color:var(--accent-blue);"></i> Report Details
                </h3>
                <div style="display:flex; gap:10px;">
                    <button id="btnModalTimeline" title="View Equipment History" style="background:var(--accent-teal-soft); border:none; color:var(--accent-teal); width:32px; height:32px; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:0.2s;">
                        <i class="fas fa-clock-rotate-left"></i>
                    </button>
                    <button onclick="closeDetails()" style="background:var(--glass-base); border:none; color:var(--text-muted); width:32px; height:32px; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:0.2s;"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="modal-scroll-content">
                <div id="detailContent" class="detail-grid"></div>
                <button class="side-btn" style="background:var(--glass-base); color:var(--text-main); margin-top:25px; border:1px solid var(--border-color);" onclick="closeDetails()">Close Window</button>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div style="display:flex; align-items:center; gap:12px;">
                <img src="https://lgyladuiyezqccyjxqgn.supabase.co/storage/v1/object/public/Image/cbmlogo.png" alt="CBM Logo" class="sidebar-logo">
                <div style="height:35px; border-left:1px solid var(--text-muted); opacity:0.3;"></div>
                <img src="https://lgyladuiyezqccyjxqgn.supabase.co/storage/v1/object/public/Image/TATA_Steel_Logo_Rev-01-removebg-preview.png" alt="Tata Steel" class="sidebar-logo tata-logo">
            </div>
            <button class="sidebar-close-btn" onclick="toggleSidebar()"><i class="fas fa-chevron-left"></i></button>
        </div>
        
        <div class="nav-section">
            <div class="nav-label">Analytics</div>
            <div class="nav-item active" id="nav-dash" onclick="switchView('dashboard')">
                <i class="fas fa-table-columns"></i> Dashboard
            </div>
            <div class="nav-item" id="nav-time" onclick="switchView('timeline')">
                <i class="fas fa-clock-rotate-left"></i> History Timeline
            </div>
        </div>

        <div class="sidebar-content">
            <div class="nav-label">Units</div>
            <div id="unitListContainer" style="margin-bottom:20px;"></div>
            <div class="nav-label">Zones</div>
            <div id="zoneListContainer"></div>
        </div>

        <div class="sidebar-footer">
            <input type="file" id="csvInput" accept=".csv" style="display:none;" onchange="handleUpload(event)">
            <button class="side-btn btn-upload-side" onclick="document.getElementById('csvInput').click()">
                <i class="fas fa-cloud-arrow-up"></i> Upload CSV
            </button>
            <button class="side-btn btn-reset-side" onclick="clearData()">
                <i class="fas fa-trash"></i> Reset Data
            </button>
            <div class="footer-credits">
                MTR Analytics Suite v5.9<br>
                <div style="margin-top:5px;">Developed by <span class="dev-name">Sourav Biswal</span></div>
            </div>
        </div>
    </div>

    <div class="main" id="mainContent">
        <div class="top-bar">
            <div class="top-left">
                <button class="toggle-btn top-icon-btn" onclick="toggleSidebar()" style="margin-left:0; margin-right:15px;"><i class="fas fa-bars"></i></button>
                <span id="pageTitle" class="page-header-title">Dashboard</span>
                <div class="filters-active" id="activeFilters"></div>
            </div>
            <div style="display:flex; align-items:center;">
                <div class="last-update" id="lastUpdateContainer" style="display:none;">
                    <i class="fas fa-calendar-check"></i> <span id="lastUpdateDate">--</span>
                </div>
                <button class="top-icon-btn" onclick="toggleTheme()" title="Toggle Theme"><i class="fas fa-moon"></i></button>
                <button class="top-icon-btn" onclick="exportPDF()" title="Export PDF"><i class="fas fa-file-pdf"></i></button>
                <button class="top-icon-btn" onclick="openSettings()"><i class="fas fa-gear"></i></button>
            </div>
        </div>

        <div class="top-stats-container">
            <div class="kpi-row">
                <div class="kpi-card k-gen active" id="card-Generated" onclick="setKPI('Generated')">
                    <div class="kpi-content"><div class="kpi-title">Total Reports</div><div class="kpi-num" id="k-gen">0</div></div>
                    <div class="kpi-icon-bg"><i class="fas fa-file-lines"></i></div>
                </div>
                <div class="kpi-card k-comp" id="card-Completed" onclick="setKPI('Completed')">
                    <div class="kpi-content"><div class="kpi-title">Completed</div><div class="kpi-num" id="k-comp">0</div></div>
                    <div class="kpi-icon-bg"><i class="fas fa-circle-check"></i></div>
                </div>
                <div class="kpi-card k-open" id="card-Open" onclick="setKPI('Open')">
                    <div class="kpi-content"><div class="kpi-title">Open Cases</div><div class="kpi-num" id="k-open">0</div></div>
                    <div class="kpi-icon-bg"><i class="fas fa-folder-open"></i></div>
                </div>
                <div class="kpi-card k-pend" id="card-Pending" onclick="setKPI('Pending')">
                    <div class="kpi-content"><div class="kpi-title">Action Pending</div><div class="kpi-num" id="k-pend">0</div></div>
                    <div class="kpi-icon-bg"><i class="fas fa-clock"></i></div>
                </div>
                <div class="kpi-card k-plan" id="card-Planned" onclick="setKPI('Planned')">
                    <div class="kpi-content"><div class="kpi-title">Action Planned</div><div class="kpi-num" id="k-plan">0</div></div>
                    <div class="kpi-icon-bg"><i class="fas fa-calendar-day"></i></div>
                </div>
            </div>
            <div class="issuer-card">
                <div class="issuer-header">Analysis Source</div>
                <div class="issuer-row">
                    <div class="issuer-label"><i class="fas fa-user-tie" style="color:var(--text-muted)"></i> Human</div>
                    <div class="issuer-val" id="valAnalyst">0</div>
                </div>
                <div class="issuer-row">
                    <div class="issuer-label"><i class="fas fa-microchip" style="color:var(--accent-teal)"></i> AI Model</div>
                    <div class="issuer-val" id="valAI">0</div>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="view-section active-view">
            <div class="dashboard-grid">
                
                <div class="d-card a-dept">
                    <div class="card-head">Department Analysis <small>Click bars to filter</small></div>
                    <div class="chart-box cb-tall"><canvas id="cDept"></canvas></div>
                </div>
                <div class="d-card a-cat">
                    <div class="card-head">Category Distribution</div>
                    <div class="chart-box cb-standard"><canvas id="cCat"></canvas></div>
                </div>
                
                <div class="d-card a-fault">
                    <div class="card-head">Fault Distribution</div>
                    <div class="fault-grid" id="faultList"></div>
                </div>

                <div class="d-card a-crit">
                    <div class="card-head" style="color:var(--accent-red)">Criticality Overview</div>
                    <div class="chart-split-wrapper">
                        <div class="chart-split-left">
                            <canvas id="cCrit"></canvas>
                            <div class="donut-center"><div class="dc-val" id="valTotalCrit">0</div></div>
                        </div>
                        <div class="chart-split-right" id="critLegendList"></div>
                    </div>
                </div>

                <div class="d-card a-age">
                    <div class="card-head">Aging Analysis</div>
                    <table id="tAge"></table>
                </div>
                <div class="d-card a-act-taken">
                    <div class="card-head">Action Taken (Open)</div>
                    <div class="chart-box cb-standard">
                        <canvas id="cDoughnut"></canvas>
                        <div class="donut-center" style="pointer-events:auto;"><div class="dc-val" id="valActTaken">0</div></div>
                    </div>
                </div>
                
                <div class="d-card a-top-equip">
                    <div class="card-head" style="color:var(--accent-red)">Top 10 Abnormal Equipment</div>
                    <div class="chart-box cb-tall"><canvas id="cTopEquip"></canvas></div>
                </div>

                <div class="d-card a-equip">
                    <div class="card-head">Equipment Type</div>
                    <div class="chart-box cb-standard"><canvas id="cEquip"></canvas></div>
                </div>
                
                <div class="d-card a-closed-under">
                    <div class="card-head" style="color:var(--accent-green)">Diagnosis Accuracy</div>
                    <div class="chart-split-wrapper">
                        <div class="chart-split-left">
                            <canvas id="cClosedUnder"></canvas>
                            <div class="donut-center"><div class="dc-val" id="valClosedUnder" style="font-size: 1.5rem;">0</div></div>
                        </div>
                        <div class="chart-split-right" id="diagnosisLegendList"></div>
                    </div>
                </div>

                <div class="d-card a-top-area">
                    <div class="card-head" style="color:var(--accent-amber)">Top 5 Abnormal Areas</div>
                    <div class="chart-box cb-standard"><canvas id="cTopArea"></canvas></div>
                </div>

                <div class="d-card a-trend">
                    <div class="card-head">7-Day Trend Analysis</div>
                    <div class="chart-box cb-tall"><canvas id="cTrend"></canvas></div>
                </div>
                <div class="d-card a-saved">
                    <div class="card-head">
                        <span style="color:var(--accent-purple)">Downtime Saved</span>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <select id="optFY" style="padding:4px 8px; font-size:0.8rem; border:1px solid var(--border-color); border-radius:6px; background:var(--bg-body); color:var(--text-main);" onchange="renderSavedChart()">
                                </select>
                            <span id="valTotalSaved" style="font-weight:800; color:var(--accent-purple); font-size:1rem;">0h</span>
                        </div>
                    </div>
                    <div class="chart-box cb-tall"><canvas id="cSaved"></canvas></div>
                </div>

                <div class="d-card a-list">
                    <div class="card-head">
                        Action Registry
                        </div>
                    <input type="text" class="table-search" id="tableSearch" placeholder="Search equipment, plant, or issue..." onkeyup="filterTable()">
                    <div style="overflow-y:auto; height:320px;">
                        <table id="tList">
                            <thead><tr><th>Date</th><th>Plant</th><th>Equipment</th><th>Recommended Corrective Action</th><th>Pending</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-timeline" class="view-section">
            <div class="timeline-wrapper">
                <div class="tl-controls">
                    <select id="tl-plant" class="tl-select" onchange="filterTimelineEquipment()">
                        <option value="">Select Plant...</option>
                    </select>
                    <select id="tl-equip" class="tl-select" onchange="renderTimeline()">
                        <option value="">Select Equipment...</option>
                    </select>
                </div>
                <div id="timeline-container" class="timeline-container">
                    <div style="text-align:center; color:var(--text-muted); padding:30px;">
                        Select a Plant and Equipment above to visualize history.
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let rawData=[], filteredData=[], activeKPI='Generated', filters={}; 
        let manualZoneMap=JSON.parse(localStorage.getItem('mtr_manual_map'))||{};
        let currentView = 'dashboard';
        let savedChartInstance = null;
        
        Chart.register(ChartDataLabels);
        Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";
        Chart.defaults.color = '#64748b';
        Chart.defaults.scale.grid.color = 'transparent'; 
        
        const ICONS={'Bearing':'fa-circle-notch','Alignment':'fa-ruler-combined','Balancing':'fa-crosshairs','Lubrication':'fa-oil-can','Electrical':'fa-bolt','Gear':'fa-gears','Flow':'fa-wind','Structure':'fa-cubes'};
        const ZONES_DEFAULT=['IRON MAKING','STEEL MAKING','PROCESS PLANT','OTHER'];
        let charts={};

        window.addEventListener('load', () => {
            if(localStorage.getItem('mtr_theme') === 'dark') {
                document.body.classList.add('dark-mode');
                document.querySelector('.top-icon-btn[title="Toggle Theme"] i').className = 'fas fa-sun';
            }
            const savedData = localStorage.getItem('mtr_data');
            if(savedData) {
                try { 
                    const dirtyData = JSON.parse(savedData); 
                    // SANITIZE ON LOAD
                    rawData = sanitizeData(dirtyData);
                    processData(); 
                    renderSidebar(); 
                    applyFilters(); 
                    initTimelineFilters(); 
                } catch(e) { console.error(e); }
            } else {
                document.getElementById('zoneListContainer').innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.85rem;">Upload Data via Bottom Button</div>';
            }
        });

        // --- CORE SANITIZATION FUNCTION (CORRECTED) ---
        function sanitizeData(data) {
            if (!Array.isArray(data)) return [];
            return data.map(row => {
                const cleanRow = {};
                Object.keys(row).forEach(key => {
                    // 1. Remove BOM, newlines, and trim
                    let cleanKey = key.replace(/^\uFEFF/, '').replace(/\r?\n/g, ' ').trim();
                    
                    // 2. Map known variations to standard keys
                    // FIX: Use strict equality (===) so "MAX. Measured Value 2" is IGNORED
                    if (cleanKey === 'MAX. Measured Value') {
                        cleanKey = 'MaxValue';
                    }
                    // Keep fuzzy match for this one as "Pending Since" often has newlines or variations
                    else if (cleanKey.includes('Pending Since')) {
                        cleanKey = 'PendingDays';
                    }
                    // FIX: Remove 'Unit3' check so it doesn't overwrite the real Unit
                    else if (cleanKey === 'Unit') {
                        cleanKey = 'Unit'; 
                    }
                    else if (cleanKey.includes('Corrective Action Taken')) {
                        cleanKey = 'ActionTaken';
                    }
                    
                    cleanRow[cleanKey] = row[key];
                });
                return cleanRow;
            });
        }

        function handleUpload(e){
            const file=e.target.files[0];
            if(!file)return;
            Papa.parse(file,{header:true,skipEmptyLines:true,complete:(res)=>{
                rawData = sanitizeData(res.data); // Sanitize immediately upon upload
                localStorage.setItem('mtr_data', JSON.stringify(rawData));
                checkAutoMap(); processData(); renderSidebar(); applyFilters(); initTimelineFilters();
            }});
        }

        function clearData() { localStorage.removeItem('mtr_data'); location.reload(); }

        function toggleSidebar(){ 
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth <= 768) {
                sb.classList.toggle('mobile-active');
                overlay.classList.toggle('active');
            } else {
                sb.classList.toggle('desktop-closed');
            }
        }

        function switchView(viewName) {
            currentView = viewName;
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.getElementById('view-' + viewName).classList.add('active-view');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(viewName === 'dashboard') document.getElementById('nav-dash').classList.add('active');
            if(viewName === 'timeline') document.getElementById('nav-time').classList.add('active');
            const titleMap = { 'dashboard': 'Overview', 'timeline': 'Equipment History' };
            document.getElementById('pageTitle').innerText = titleMap[viewName];
            if (window.innerWidth <= 768) toggleSidebar();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('mtr_theme', isDark ? 'dark' : 'light');
            document.querySelector('.top-icon-btn[title="Toggle Theme"] i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            Chart.defaults.color = isDark ? '#94a3b8' : '#64748b';
            renderCharts(); 
        }

        function processData(){
            const today=new Date();
            let maxDate = null; 
            rawData.forEach(r=>{
                try {
                    r._dateObj=null; r._daysOld=0; r._fy = '';
                    if(r.Date) {
                        let p = r.Date.split(/[-/]/); // Handle both - and /
                        if(p.length===3) {
                            r._dateObj=new Date(p[2],p[1]-1,p[0]);
                            r._daysOld=Math.ceil(Math.abs(today-r._dateObj)/(1000*60*60*24));
                            if(!maxDate || r._dateObj > maxDate) maxDate = r._dateObj;
                            const month = r._dateObj.getMonth();
                            const year = r._dateObj.getFullYear();
                            const fyYear = (month >= 3) ? year + 1 : year;
                            r._fy = 'FY' + String(fyYear).slice(-2);
                        }
                    }
                    r._closedDateObj=null;
                    if(r['Action Taken Date']) {
                         const p=r['Action Taken Date'].split(/[-/]/);
                         if(p.length===3) r._closedDateObj=new Date(p[2],p[1]-1,p[0]);
                    }
                    r._drs=(r['DRS Status']||'').trim();
                    r._act=(r['Action Status']||'').trim();
                    r._saved = parseFloat(r['Hours Saved']) || 0; 
                    r._zone = (r['ZONE'] && r['ZONE'].trim()) ? r['ZONE'].trim().toUpperCase() : (manualZoneMap[r.Plant] || 'OTHER');
                    r._unit = (r['Org. Unit'] || 'Unknown').trim();
                    let cu = (r['Closed Under']||'').trim().toUpperCase();
                    if (cu.includes('TRUE') || cu === 'TP') r._closedUnder = 'TP';
                    else if (cu.includes('FALSE POS') || cu === 'FP') r._closedUnder = 'FP';
                    else if (cu.includes('FALSE NEG') || cu === 'FN') r._closedUnder = 'FN';
                    else r._closedUnder = 'N/A';
                } catch(e) { console.warn("Row processing error", e, r); }
            });
            if(maxDate) {
                const dateStr = maxDate.toLocaleDateString('en-GB'); 
                document.getElementById('lastUpdateDate').innerText = dateStr;
                document.getElementById('lastUpdateContainer').style.display = 'flex';
            }
            populateFYDropdown();
        }
        
        function populateFYDropdown() {
            const fys = new Set();
            rawData.forEach(r => { if(r._saved > 0 && r._fy) fys.add(r._fy); });
            const sortedFYs = Array.from(fys).sort().reverse();
            const sel = document.getElementById('optFY');
            sel.innerHTML = '';
            if(sortedFYs.length === 0) { sel.innerHTML = '<option value="">No Data</option>'; return; }
            sortedFYs.forEach(fy => { sel.innerHTML += `<option value="${fy}">${fy}</option>`; });
            sel.value = sortedFYs[0];
        }

        function setKPI(k){ activeKPI=k; document.querySelectorAll('.kpi-card').forEach(c=>c.classList.remove('active')); document.getElementById(`card-${k}`).classList.add('active'); applyFilters(); }
        function toggleFilter(k,v){ if(filters[k]===v) delete filters[k]; else filters[k]=v; applyFilters(); }

        function applyFilters(){
            let set=rawData;
            if(activeKPI==='Completed') set=set.filter(r=>r._drs==='Completed'&&r._act==='Completed');
            else if(activeKPI==='Pending') set=set.filter(r=>r._drs==='Action Pending'&&r._act==='Action Pending');
            else if(activeKPI==='Planned') set=set.filter(r=>r._drs==='Action Planned'&&r._act==='Action Planned');
            else if(activeKPI==='Open') set=set.filter(r=>(r._drs==='Action Pending'&&r._act==='Action Pending')||(r._drs==='Action Planned'&&r._act==='Action Planned'));

            filteredData=set.filter(r=>{
                for(const [k,v] of Object.entries(filters)){
                    if(k==='Age') {
                        if(r._drs === 'Completed') return false; 
                        if(v==='0-15 Days' && !(r._daysOld<=15)) return false;
                        if(v==='15-30 Days' && !(r._daysOld>15 && r._daysOld<=30)) return false;
                        if(v==='30-60 Days' && !(r._daysOld>30 && r._daysOld<=60)) return false;
                        if(v==='> 60 Days' && !(r._daysOld>60)) return false;
                    }
                    else if(k==='Zone'){if(r._zone!==v)return false;}
                    else if(k==='Unit'){if(r._unit!==v)return false;}
                    else if(k==='Fault'){ if(!r['Issue On Short']||!r['Issue On Short'].includes(v))return false; }
                    else if(k==='AreaComposite') {
                        const separatorIndex = v.indexOf(' - ');
                        if (separatorIndex === -1) return false;
                        const p = v.substring(0, separatorIndex);
                        const a = v.substring(separatorIndex + 3);
                        if (r.Plant !== p || r.Area !== a) return false;
                    }
                    else if(k==='Closed Under'){ if(r._closedUnder !== v) return false; }
                    else if(k==='Criticality'){ if(r['Criticality'] !== v) return false; }
                    else{if(r[k]!==undefined && r[k]!==v)return false;}
                }
                return true;
            });
            renderDashboard();
        }

        function renderDashboard(){ updateKPIs(); renderCharts(); renderWidgets(); renderFilterTags(); renderSidebar(); }

        function updateKPIs(){
            const ctx=rawData.filter(r=>{
                for(const [k,v] of Object.entries(filters)){
                    if(k==='Age') { if(r._drs === 'Completed') return false; if(v==='0-15 Days' && !(r._daysOld<=15)) return false; if(v==='15-30 Days' && !(r._daysOld>15 && r._daysOld<=30)) return false; if(v==='30-60 Days' && !(r._daysOld>30 && r._daysOld<=60)) return false; if(v==='> 60 Days' && !(r._daysOld>60)) return false; }
                    else if(k==='Zone'){if(r._zone!==v)return false;}
                    else if(k==='Unit'){if(r._unit!==v)return false;}
                    else if(k==='Fault'){ if(!r['Issue On Short']||!r['Issue On Short'].includes(v))return false; }
                    else if(k==='AreaComposite') {
                        const separatorIndex = v.indexOf(' - ');
                        if (separatorIndex === -1) return false;
                        const p = v.substring(0, separatorIndex);
                        const a = v.substring(separatorIndex + 3);
                        if (r.Plant !== p || r.Area !== a) return false;
                    }
                    else if(k==='Closed Under'){ if(r._closedUnder !== v) return false; }
                    else if(k==='Criticality'){ if(r['Criticality'] !== v) return false; }
                    else{if(r[k]!==undefined && r[k]!==v)return false;}
                }
                return true;
            });
            const c=(fn)=>ctx.filter(fn).length;
            document.getElementById('k-gen').innerText=ctx.length;
            document.getElementById('k-comp').innerText=c(r=>r._drs==='Completed'&&r._act==='Completed');
            document.getElementById('k-open').innerText=c(r=>(r._drs==='Action Pending'&&r._act==='Action Pending')||(r._drs==='Action Planned'&&r._act==='Action Planned'));
            document.getElementById('k-pend').innerText=c(r=>r._drs==='Action Pending'&&r._act==='Action Pending');
            document.getElementById('k-plan').innerText=c(r=>r._drs==='Action Planned'&&r._act==='Action Planned');
            window.actTakenCount=filteredData.filter(r=>(r._drs.includes('Pending')||r._drs.includes('Planned'))&&r._act==='Completed').length;
        }

        function renderCharts(){
            const data=filteredData;
            const agg=(k)=>{const m={};data.forEach(r=>{const v=r[k]||'N/A';m[v]=(m[v]||0)+1});return m;};
            
            const isDark = document.body.classList.contains('dark-mode');
            const txtColor = isDark ? '#cbd5e1' : '#475569';
            const colors = { red: '#e11d48', orange: '#d97706', green: '#059669', teal: '#0d9488', blue: '#2563eb', purple: '#7c3aed', slate: '#64748b' };

            const plants=[...new Set(data.map(r=>r.Plant))];
            drawChart('cDept', 'bar', {
                labels:plants,
                datasets:[
                    {label:'Critical',data:plants.map(p=>data.filter(r=>r.Plant===p&&r.Criticality==='Critical').length),backgroundColor:colors.red, stack:'0', borderRadius: 3, barPercentage: 0.8, categoryPercentage: 0.9},
                    {label:'Marginal',data:plants.map(p=>data.filter(r=>r.Plant===p&&r.Criticality==='Marginal').length),backgroundColor:colors.orange, stack:'0', borderRadius: 3, barPercentage: 0.8, categoryPercentage: 0.9}
                ]
            }, 'Plant', { scales: { x: { stacked: true }, y: { stacked: true, display: false } } });

            const cats=agg('Category');
            drawChart('cCat', 'bar', {
                labels:Object.keys(cats),
                datasets:[{data:Object.values(cats),backgroundColor:colors.teal,label:'Count', borderRadius: 50, barThickness: 20}]
            }, 'Category');

            const equips=agg('Type');
            drawChart('cEquip', 'bar', {
                labels:Object.keys(equips),
                datasets:[{ data:Object.values(equips), backgroundColor:colors.slate, label:'Count', indexAxis: 'y', borderRadius: 50, barPercentage: 0.9, categoryPercentage: 0.9 }]
            }, 'Type', { indexAxis: 'y' }); 

            const critCounts = {'Critical':0, 'Marginal':0, 'Normal':0};
            data.forEach(r => {
                const c = r.Criticality || 'Normal';
                if(c === 'Critical') critCounts['Critical']++;
                else if(c === 'Marginal') critCounts['Marginal']++;
                else critCounts['Normal']++;
            });
            document.getElementById('valTotalCrit').innerText = data.length;

            drawChart('cCrit', 'doughnut', {
                labels: ['Critical', 'Marginal', 'Normal'],
                datasets: [{ data: [critCounts['Critical'], critCounts['Marginal'], critCounts['Normal']], backgroundColor: [colors.red, colors.orange, colors.slate], borderWidth: 0, hoverOffset: 4 }]
            }, 'Criticality', { cutout: '75%', borderRadius: 20, plugins: { legend: { display: false }, datalabels: { display: false } } });

            const critLegend = document.getElementById('critLegendList');
            critLegend.innerHTML = '';
            const critItems = [ { key: 'Critical', count: critCounts['Critical'], color: colors.red }, { key: 'Marginal', count: critCounts['Marginal'], color: colors.orange }, { key: 'Normal', count: critCounts['Normal'], color: colors.slate } ];
            critItems.forEach(item => {
                if(item.count > 0 || item.key !== 'Normal') {
                    const pct = data.length > 0 ? ((item.count / data.length) * 100).toFixed(1) + '%' : '0.0%';
                    const isActive = filters['Criticality'] === item.key;
                    const div = document.createElement('div');
                    div.className = `legend-item ${isActive ? 'active-filter' : ''}`;
                    div.innerHTML = `<div class="diag-info"><div class="legend-head">${item.key}</div><div><span class="legend-dot" style="background:${item.color}"></span><span class="legend-val" style="font-size:0.9rem;">${pct}</span></div></div><div class="legend-val">${item.count}</div>`;
                    div.onclick = () => toggleFilter('Criticality', item.key);
                    critLegend.appendChild(div);
                }
            });

            const actionTakenRows = data.filter(r=>(r._drs.includes('Pending')||r._drs.includes('Planned'))&&r._act==='Completed');
            const taken = actionTakenRows.length;
            const actionTakenNames = actionTakenRows.map(r => r['Equipment Name'] || 'Unknown');
            document.getElementById('valActTaken').innerText=taken;

            const centerEl = document.getElementById('valActTaken'); const centerDiv = centerEl.parentElement; 
            const showNames = () => { if(actionTakenNames.length > 0) { centerEl.style.fontSize = actionTakenNames.length > 2 ? '0.75rem' : '0.8rem'; centerEl.innerText = actionTakenNames.length > 2 ? actionTakenNames.slice(0, 2).join('\n') + `\n(+${actionTakenNames.length - 2})` : actionTakenNames.join('\n'); } };
            const showCount = () => { centerEl.style.fontSize = '2rem'; centerEl.innerText = taken; };
            centerDiv.onmouseenter = showNames; centerDiv.onmouseleave = showCount;

            drawChart('cDoughnut', 'doughnut', {
                labels:['Action Taken (Open)','Other'],
                datasets:[{data:[taken, data.length-taken],backgroundColor:[colors.teal, isDark ? '#1e293b' : '#e2e8f0'],borderWidth:0}]
            }, null, { cutout: '80%', borderRadius: 20, onHover: (e, elements) => { if (elements && elements.length > 0 && elements[0].index === 0) showNames(); else if(!centerDiv.matches(':hover')) showCount(); } });

            const dateSet = new Set(); const genMap = {}; const closedMap = {};
            data.forEach(r => { if(r.Date) { dateSet.add(r.Date); genMap[r.Date] = (genMap[r.Date]||0)+1; } if(r['Action Taken Date']) { dateSet.add(r['Action Taken Date']); closedMap[r['Action Taken Date']] = (closedMap[r['Action Taken Date']]||0)+1; } });
            const sortedDates = Array.from(dateSet).sort((a,b) => { const da = a.split('-').reverse().join(''); const db = b.split('-').reverse().join(''); return da.localeCompare(db); }).slice(-7);
            
            const ctxTrend = document.getElementById('cTrend').getContext('2d');
            const gradBlue = ctxTrend.createLinearGradient(0, 0, 0, 300);
            gradBlue.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); gradBlue.addColorStop(1, 'rgba(59, 130, 246, 0.0)');
            const gradGreen = ctxTrend.createLinearGradient(0, 0, 0, 300);
            gradGreen.addColorStop(0, 'rgba(16, 185, 129, 0.5)'); gradGreen.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

            drawChart('cTrend', 'line', {
                labels: sortedDates,
                datasets: [
                    {label: 'Generated', data: sortedDates.map(d => genMap[d] || 0), borderColor: colors.blue, backgroundColor: gradBlue, fill: true, borderWidth: 3, pointRadius: 4, tension: 0.4},
                    {label: 'Closed', data: sortedDates.map(d => closedMap[d] || 0), borderColor: colors.green, backgroundColor: gradGreen, fill: true, borderWidth: 3, pointRadius: 4, tension: 0.4}
                ]
            }, null, { plugins: { legend: { display: true, position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } } }, scales: { y: { beginAtZero: true } } });

            const eqCounts = {}; data.filter(r => r._drs !== 'Completed').forEach(r => { const n = r['Equipment Name']; if(n) eqCounts[n] = (eqCounts[n] || 0) + 1; });
            const top10 = Object.entries(eqCounts).sort((a,b) => b[1]-a[1]).slice(0, 10);
            drawChart('cTopEquip', 'bar', {
                labels: top10.map(i => i[0]), 
                datasets: [{ label: 'Open Faults', data: top10.map(i => i[1]), backgroundColor: colors.red, indexAxis: 'y', borderRadius: 50, barThickness: 10 }]
            }, 'Equipment Name', { indexAxis: 'y', layout: { padding: { left: 0 } }, scales: { x: { display: false }, y: { display: true, grid: { display: false }, ticks: { font: { size: 9 } } } } });

            const areaCounts = {}; data.forEach(r => { const key = `${r.Plant || 'Unknown'} - ${r.Area || 'Unknown'}`; areaCounts[key] = (areaCounts[key] || 0) + 1; });
            const top5Areas = Object.entries(areaCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
            drawChart('cTopArea', 'bar', {
                labels: top5Areas.map(i => i[0]),
                datasets: [{ label: 'Reports', data: top5Areas.map(i => i[1]), backgroundColor: colors.orange, indexAxis: 'y', borderRadius: 50, barThickness: 12 }]
            }, 'AreaComposite', { indexAxis: 'y', layout: { padding: { left: 0 } }, scales: { x: { display: false }, y: { display: true, ticks: { font: { size: 9 } } } } });

            const closedUnderCounts = { 'TP': 0, 'FP': 0, 'FN': 0 }; let totalClosedUnder = 0;
            data.forEach(r => { if (r._closedUnder && r._closedUnder !== 'N/A') { closedUnderCounts[r._closedUnder]++; totalClosedUnder++; } });
            document.getElementById('valClosedUnder').innerText = totalClosedUnder;

            drawChart('cClosedUnder', 'doughnut', {
                labels: ['TP', 'FP', 'FN'],
                datasets: [{ data: [closedUnderCounts['TP'], closedUnderCounts['FP'], closedUnderCounts['FN']], backgroundColor: [colors.green, colors.orange, colors.red], borderWidth: 0, hoverOffset: 4 }]
            }, 'Closed Under', { cutout: '75%', borderRadius: 20, plugins: { legend: { display: false }, datalabels: { display: false } } });

            const legendContainer = document.getElementById('diagnosisLegendList'); legendContainer.innerHTML = ''; 
            const diagItems = [ { key: 'TP', label: 'True Positive', count: closedUnderCounts['TP'], color: colors.green }, { key: 'FP', label: 'False Positive', count: closedUnderCounts['FP'], color: colors.orange }, { key: 'FN', label: 'False Negative', count: closedUnderCounts['FN'], color: colors.red } ];
            diagItems.forEach(item => {
                const pct = totalClosedUnder > 0 ? ((item.count / totalClosedUnder) * 100).toFixed(1) + '%' : '0.0%';
                const isActive = filters['Closed Under'] === item.key;
                const div = document.createElement('div');
                div.className = `legend-item ${isActive ? 'active-filter' : ''}`;
                div.innerHTML = `<div class="diag-info"><div class="legend-head">${item.key}</div><div><span class="legend-dot" style="background:${item.color}"></span><span class="legend-val" style="font-size:0.9rem;">${pct}</span></div></div><div class="legend-val">${item.count}</div>`;
                div.onclick = () => toggleFilter('Closed Under', item.key);
                legendContainer.appendChild(div);
            });
            
            renderSavedChart();
        }

        function renderSavedChart() {
            const selectedFY = document.getElementById('optFY').value;
            const fyData = filteredData.filter(r => r._fy === selectedFY && r._saved > 0);
            const monthOrder = ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'];
            const savedByMonth = new Array(12).fill(0);
            let totalSaved = 0;
            fyData.forEach(r => { if(r._dateObj) { let mIndex = r._dateObj.getMonth(); let sortIndex = (mIndex >= 3) ? mIndex - 3 : mIndex + 9; savedByMonth[sortIndex] += r._saved; totalSaved += r._saved; } });
            document.getElementById('valTotalSaved').innerText = totalSaved + 'h';
            const ctx = document.getElementById('cSaved').getContext('2d');
            if(savedChartInstance) savedChartInstance.destroy();
            const txtColor = document.body.classList.contains('dark-mode') ? '#cbd5e1' : '#64748b';
            savedChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: monthOrder, datasets: [{ label: 'Hours Saved', data: savedByMonth, backgroundColor: '#7c3aed', borderRadius: 50, barThickness: 15 }] },
                plugins: [ChartDataLabels],
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: txtColor, anchor: 'end', align: 'top', formatter: (v) => v > 0 ? v : '' } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });
        }

        function drawChart(id, type, data, filterKey, extraOptions={}){
            const ctx = document.getElementById(id).getContext('2d');
            if(charts[id]) charts[id].destroy();
            const defaultScales = (type === 'doughnut') ? {} : { x: { display: extraOptions.indexAxis !== 'y', grid: { display:false } }, y: { display: extraOptions.indexAxis === 'y', grid: { display:false } } };
            const scales = extraOptions.scales || defaultScales;

            charts[id] = new Chart(ctx, {
                type: type, data: data, plugins: [ChartDataLabels],
                options: {
                    ...extraOptions, responsive: true, maintainAspectRatio: false, 
                    interaction: { mode: 'nearest', axis: extraOptions.indexAxis === 'y' ? 'y' : 'x', intersect: true },
                    plugins: {
                        legend: { display: type !== 'bar' && type !== 'doughnut' },
                        datalabels: { color: document.body.classList.contains('dark-mode') ? '#fff' : '#333', font: { weight: 'bold', size: 10 }, display: (ctx) => ctx.dataset.data[ctx.dataIndex] > 0, align: type === 'line' ? 'top' : 'center', formatter: (v) => v },
                        ...(extraOptions.plugins || {})
                    },
                    scales: scales,
                    onClick: (e, el) => { if (el.length && filterKey) { const idx = el[0].index; const val = (extraOptions.filterValues) ? extraOptions.filterValues[idx] : data.labels[idx]; toggleFilter(filterKey, val); } },
                    onHover: (e, el) => { e.native.target.style.cursor = el[0] ? 'pointer' : 'default'; if(extraOptions.onHover) extraOptions.onHover(e, el); }
                }
            });
        }

        function renderWidgets(){
            const faults={}; filteredData.forEach(r=>{ if(r['Issue On Short']) r['Issue On Short'].split(',').forEach(i=>{const x=i.trim(); if(x) faults[x]=(faults[x]||0)+1;}); });
            const fList=document.getElementById('faultList'); fList.innerHTML='';
            Object.entries(faults).sort((a,b)=>b[1]-a[1]).forEach(([f,c])=>{
                let icon='fa-triangle-exclamation'; for(const [k,v] of Object.entries(ICONS))if(f.includes(k))icon=v;
                fList.innerHTML+=`<div class="fault-pill ${filters['Fault']===f?'active':''}" onclick="toggleFilter('Fault','${f}')"><span><i class="fas ${icon}" style="margin-right:8px; opacity:0.7;"></i>${f}</span><b>${c}</b></div>`;
            });

            const buckets={'0-15 Days':0,'15-30 Days':0,'30-60 Days':0,'> 60 Days':0};
            filteredData.forEach(r=>{ if(r._drs!=='Completed'){ if(r._daysOld<=15)buckets['0-15 Days']++; else if(r._daysOld<=30)buckets['15-30 Days']++; else if(r._daysOld<=60)buckets['30-60 Days']++; else buckets['> 60 Days']++; } });
            const tAge=document.getElementById('tAge'); tAge.innerHTML='';
            const palette = ['#10b981', '#f59e0b', '#f43f5e', '#881337'];
            Object.entries(buckets).forEach(([k,v],i)=>{
                if(v>0) {
                    const activeClass = filters['Age'] === k ? 'active' : '';
                    tAge.innerHTML+=`<tr class="age-row ${activeClass}" onclick="toggleFilter('Age', '${k}')"><td><i class="fas fa-circle" style="color:${palette[i]}; font-size:0.6rem; margin-right:8px;"></i>${k}</td><td style="text-align:right; font-weight:700;">${v}</td></tr>`;
                }
            });

            let ana = 0, ai = 0;
            filteredData.forEach(r => { const val = (r['Isssued By'] || r['Report Issued By'] || '').trim(); if(val.toLowerCase().endsWith('@infinite-uptime.com')) ana++; else if(val.toUpperCase().includes('NITY')) ai++; });
            document.getElementById('valAnalyst').innerText = ana; document.getElementById('valAI').innerText = ai;

            // Render Table (limited to first 50 or search)
            renderTable(filteredData.slice(0, 50));
        }

        // --- NEW: Filter Function for Search Bar ---
        function filterTable() {
            const input = document.getElementById("tableSearch");
            const filter = input.value.toUpperCase();
            const filteredRows = filteredData.filter(r => {
                const text = (r.Plant + ' ' + r['Equipment Name'] + ' ' + r['Recommended Actions']).toUpperCase();
                return text.includes(filter);
            });
            renderTable(filteredRows.slice(0, 50));
        }

        function renderTable(data) {
            const tbody=document.querySelector('#tList tbody'); tbody.innerHTML='';
            data.forEach((r, index)=>{ 
                let trendIcon = ''; const trendVal = (r.Trend || '').toLowerCase();
                if(trendVal.includes('increas')) trendIcon = '<i class="fas fa-arrow-trend-up" style="color:var(--accent-red); margin-left:5px;"></i>';
                else if(trendVal.includes('decreas')) trendIcon = '<i class="fas fa-arrow-trend-down" style="color:var(--accent-green); margin-left:5px;"></i>';
                else if(trendVal.includes('stable')) trendIcon = '<i class="fas fa-minus" style="color:var(--text-muted); margin-left:5px; font-size:0.7rem;"></i>';
                
                // Pending Days Logic
                const days = r['PendingSince(InDays)'] || r['PendingDays'] || r._daysOld || 0;
                
                let badgeClass = 'pb-safe';
                if(days > 60) badgeClass = 'pb-critical';
                else if(days > 30) badgeClass = 'pb-warning';

                tbody.innerHTML+=`
                    <tr onclick="showDetails(${index})" style="cursor:pointer; transition:0.2s;" onmouseover="this.style.background='var(--glass-border)'" onmouseout="this.style.background='transparent'">
                        <td>${r.Date}</td>
                        <td>${r.Plant}</td>
                        <td style="font-weight:600; color:var(--text-main);">${r['Equipment Name']} ${trendIcon}</td>
                        <td style="font-weight:600; color:var(--text-main);">${r['Recommended Actions']}</td>
                        <td><span class="pending-badge ${badgeClass}">${days} Days</span></td>
                    </tr>`;
            });
        }

        // --- UPDATED: Detail Modal Logic with Sanitized Keys ---
        function showDetails(index) {
            const r = filteredData[index];
            const content = document.getElementById('detailContent');
            
            // Setup Timeline Jump Button
            const btnTimeline = document.getElementById('btnModalTimeline');
            btnTimeline.onclick = function() { jumpToTimelineFromModal(index); };

            // Helper to generate a field block
            const field = (label, value, fullWidth=false, customClass='') => `
                <div class="detail-item ${fullWidth ? 'detail-full' : ''} ${customClass}">
                    <div class="detail-label">${label}</div>
                    <div class="detail-value">${value || '-'}</div>
                </div>`;

            // Combine Value + Unit (NOW FIXED WITH SANITIZED KEYS)
            const measuredValue = r['MaxValue'] || '-'; 
            const measureUnit = r['Unit'] || '';
            const displayValue = (measuredValue !== '-') ? `${measuredValue} ${measureUnit}` : '-';

            content.innerHTML = `
                ${field('Plant', r.Plant)}
                ${field('Area', r.Area)}
                ${field('Equipment Name', r['Equipment Name'], true)}
                ${field('Category', r.Category)}
                ${field('Type', r.Type)}
                ${field('Measured Location', r['Measured Location'])}
                ${field('Max Value', displayValue)}
                ${field('Criticality', `<span style="color:${r.Criticality==='Critical'?'var(--accent-red)':'var(--accent-amber)'}; font-weight:800;">${r.Criticality}</span>`)}
                ${field('Observations', r.Observation, true, 'detail-obs')}
                ${field('Recommendations', r['Recommended Actions'], true, 'detail-rec')}
                ${field('Remarks', r.Remarks, true)}
            `;
            
            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeDetails() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function jumpToTimelineFromModal(index) {
            const r = filteredData[index];
            closeDetails();
            switchView('timeline');
            const plantSelect = document.getElementById('tl-plant');
            plantSelect.value = r.Plant;
            filterTimelineEquipment(); 
            const equipSelect = document.getElementById('tl-equip');
            equipSelect.value = r['Equipment Name'];
            renderTimeline();
        }

        function renderSidebar(){
            const units = {}; rawData.forEach(r=> { if(r._unit && r._unit !=='Unknown') units[r._unit] = (units[r._unit]||0)+1; });
            const uCont = document.getElementById('unitListContainer'); uCont.innerHTML = '';
            Object.keys(units).sort().forEach(u => {
                uCont.innerHTML += `<div class="filter-card unit-card ${filters['Unit']===u?'active':''}" onclick="toggleFilter('Unit','${u}')"><div class="icon-box"><i class="fas fa-building-columns unit-icon"></i></div><div class="card-info"><span class="card-name">${u}</span><span class="card-count">${units[u]} Reports</span></div></div>`;
            });
            const zones={}; rawData.filter(r => !filters['Unit'] || r._unit === filters['Unit']).forEach(r=>zones[r._zone]=(zones[r._zone]||0)+1);
            const cont=document.getElementById('zoneListContainer'); cont.innerHTML='';
            Object.keys(zones).sort().forEach(z=>{
                let cls='', icon='fa-industry';
                if(z.includes('IRON')){cls='zone-iron';icon='fa-fire';} else if(z.includes('STEEL')){cls='zone-steel';icon='fa-layer-group';} else if(z.includes('PROCESS')){cls='zone-process';icon='fa-gears';}
                cont.innerHTML+=`<div class="filter-card zone-card ${cls} ${filters['Zone']===z?'active':''}" onclick="toggleFilter('Zone','${z}')"><div class="icon-box"><i class="fas ${icon}"></i></div><div class="card-info"><span class="card-name">${z}</span><span class="card-count">${zones[z]} Reports</span></div></div>`;
            });
        }

        function renderFilterTags(){
            const c=document.getElementById('activeFilters'); c.innerHTML='';
            Object.entries(filters).forEach(([k,v])=>{c.innerHTML+=`<div class="filter-tag">${k}: ${v} <i class="fas fa-xmark" style="cursor:pointer; opacity:0.8;" onclick="toggleFilter('${k}','${v}')"></i></div>`;});
        }
        function checkAutoMap(){ const p=[...new Set(rawData.map(r=>r.Plant))].sort(); const c=document.getElementById('mappingContainer'); c.innerHTML=''; p.forEach(pl=>{ const cur=manualZoneMap[pl]||''; let o=`<option value="">Use CSV Default</option>`; ZONES_DEFAULT.forEach(z=>o+=`<option value="${z}" ${cur===z?'selected':''}>${z}</option>`); c.innerHTML+=`<div class="map-row"><span>${pl}</span><select id="map_${pl}">${o}</select></div>`; }); }
        function openSettings(){document.getElementById('settingsModal').style.display='flex';}
        function closeSettings(){document.getElementById('settingsModal').style.display='none';}
        function saveMappings(){ document.querySelectorAll('[id^="map_"]').forEach(i=>{if(i.value)manualZoneMap[i.id.replace('map_','')]=i.value;else delete manualZoneMap[i.id.replace('map_','')];}); localStorage.setItem('mtr_manual_map',JSON.stringify(manualZoneMap)); closeSettings(); processData(); renderSidebar(); applyFilters(); }

        function initTimelineFilters() {
            const plants = [...new Set(rawData.map(r => r.Plant))].sort();
            const pSelect = document.getElementById('tl-plant'); pSelect.innerHTML = '<option value="">Select Plant...</option>';
            plants.forEach(p => pSelect.innerHTML += `<option value="${p}">${p}</option>`);
        }
        function filterTimelineEquipment() {
            const selectedPlant = document.getElementById('tl-plant').value;
            const eSelect = document.getElementById('tl-equip'); eSelect.innerHTML = '<option value="">Select Equipment...</option>';
            if (!selectedPlant) return;
            const equips = [...new Set(rawData.filter(r => r.Plant === selectedPlant).map(r => r['Equipment Name']))].sort();
            equips.forEach(e => eSelect.innerHTML += `<option value="${e}">${e}</option>`);
        }
        
        // --- FIXED RENDER TIMELINE FUNCTION ---
        function renderTimeline() {
            const plant = document.getElementById('tl-plant').value; 
            const equip = document.getElementById('tl-equip').value;
            const container = document.getElementById('timeline-container');
            
            if (!plant || !equip) { 
                container.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:30px;">Select a Plant and Equipment above to visualize history.</div>'; 
                return; 
            }
            
            const history = rawData.filter(r => r.Plant === plant && r['Equipment Name'] === equip);
            history.sort((a, b) => (b._dateObj || 0) - (a._dateObj || 0));
            container.innerHTML = '';
            
            if (history.length === 0) { 
                container.innerHTML = '<div style="text-align:center; padding:20px;">No records found.</div>'; 
                return; 
            }
            
            history.forEach(r => {
                const critClass = (r.Criticality === 'Critical') ? 'critical' : (r.Criticality === 'Marginal' ? 'marginal' : '');
                
                let actionHTML = '';
                // FIX: Check for the SANITIZED key 'ActionTaken' instead of the raw CSV header
                if (r['ActionTaken'] && r['ActionTaken'].trim() !== '') { 
                    actionHTML = `
                        <div class="tl-action-box">
                            <div class="tl-action-date" style="font-size:0.75rem; font-weight:700; margin-bottom:4px; opacity:0.8;">
                                <i class="fas fa-check-double"></i> Action Taken: ${r['Action Taken Date'] || 'Date Not Recorded'}
                            </div>
                            <div class="tl-action-text">${r['ActionTaken']}</div>
                        </div>`; 
                }
                
                container.innerHTML += `
                    <div class="tl-item ${critClass}">
                        <span class="tl-dot"></span>
                        <div class="tl-content">
                            <div class="tl-date">
                                <span><i class="far fa-calendar"></i> ${r.Date}</span>
                                <span style="font-size:0.75rem; text-transform:uppercase; font-weight:700; color:var(--text-main);">${r.Criticality || 'Normal'}</span>
                            </div>
                            <div class="tl-obs" style="margin-top:5px; font-size:1.1rem; font-weight:600;">${r.Observation || 'No Observation'}</div>
                            <div class="tl-rec" style="margin-top:8px; color:var(--text-muted); font-size:0.9rem;">
                                <i class="fas fa-screwdriver-wrench" style="margin-right:5px;"></i> ${r['Recommended Actions'] || 'No Recommendation'}
                            </div>
                            ${actionHTML}
                        </div>
                    </div>`;
            });
        }

        async function exportPDF() {
            document.body.classList.add('print-mode'); window.dispatchEvent(new Event('resize'));
            await new Promise(resolve => setTimeout(resolve, 800));
            const element = document.querySelector('.main');
            const orientation = (currentView === 'dashboard') ? 'landscape' : 'portrait';
            const opt = { margin: 5, filename: currentView === 'dashboard' ? 'MTR_Analytics.pdf' : 'Equipment_History.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: orientation }, pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } };
            await html2pdf().set(opt).from(element).save();
            document.body.classList.remove('print-mode'); window.dispatchEvent(new Event('resize'));
        }
    </script>
</body>
</html>
